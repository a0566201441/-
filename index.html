<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ (v5 - Ù†Ù‡Ø§Ø¦ÙŠ)</title>
Â  <style>
Â  Â  * {
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â Â 
Â  Â  body{font-family:"Segoe UI",Tahoma,Arial,sans-serif;background:#0b0f14;color:#e9eef5;margin:0;padding:20px}
Â  Â  h1{margin-bottom:16px;font-size:1.4rem;color:#fff}
Â  Â  .card{background:#121822;border:1px solid #1e2a3a;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 6px 14px rgba(0,0,0,.35)}
Â  Â  label{display:block;margin-top:10px;margin-bottom:6px;font-size:.9rem;color:#cbd5e1}
Â  Â  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a52;background:#0f141c;color:#e9eef5}
Â  Â  textarea{min-height:84px;resize:vertical}
Â  Â  button{padding:8px 14px;border-radius:10px;border:none;cursor:pointer;transition:opacity .2s}
Â  Â  button:hover{opacity:.9}
Â  Â  .danger{background:#ef4444;color:#fff}
Â  Â  .primary{background:#1e90ff;color:#fff}
Â  Â  .ghost{background:transparent;border:1px solid #2a3a52;color:#cbd5e1}
Â  Â  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#132032;color:#9cc2ff;font-size:.85rem}
Â  Â  .totals{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
Â  Â  .totals div{background:#0f141c;border:1px solid #1f2a3a;border-radius:12px;padding:12px;text-align:center}
Â  Â  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â  Â  .row > div { margin-left: 15px; margin-right: 15px; }
Â  Â  .muted{color:#9fb1cc;font-size:.9rem}

Â  Â  table.main-table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px;display:block;overflow-x:auto;white-space:nowrap}
Â  Â  th,td{text-align:center;padding:12px}
Â  Â  .main-table th, .main-table td{min-width:120px}
Â  Â  thead th{background:#1a2230;color:#cbd5e1;font-weight:600}
Â  Â  tbody tr{background:#0f141c;border:1px solid #1f2a3a}
Â  Â  tbody td{border-top:1px solid #1f2a3a}
Â  Â  .col-planned, td.col-planned {min-width:130px}
Â  Â  .col-paid, td.col-paid {min-width:130px}
Â  Â  .col-due, td.col-due {min-width:140px}
Â  Â  .main-table td input[type='number']{width:120px}
Â  Â  .main-table td input[type='text']{width:160px}

Â  Â  .status{font-weight:700}
Â  Â  .status.Ù…Ø¯ÙÙˆØ¹{color:#22c55e}
Â  Â  .status.Ù…Ø¯ÙÙˆØ¹-Ø¬Ø²Ø¦ÙŠ{color:#facc15}
Â  Â  .status.ØºÙŠØ±-Ù…Ø¯ÙÙˆØ¹{color:#1e90ff}
Â  Â  .status.Ø¯Ø®Ù„{color:#60a5fa}

Â  Â  .sub-table{margin-top:8px;border:1px solid #2a3a52;border-radius:10px;width:100%}
Â  Â  .sub-table th{background:#1a2230;color:#9cc2ff}
Â  Â  .sub-table td{background:#141c26}

Â  Â  #history-chart-wrap{height:260px;position:relative;margin-top:16px}
Â  Â  #delta-chart-wrap{height:240px;position:relative;margin-top:16px}
Â  Â  #history-chart,#delta-chart{width:100% !important;height:100% !important;display:block}
Â  </style>

<style id="mobile-v29">
@media (max-width: 430px) {
  html, body {
    margin:0;
    padding: 10px;
    width:100%;
    max-width:100vw;
    overflow-x:hidden;
  }
  
  #extras-table thead {
    display: none;
  }
  #extras-rows tr {
    display: grid;
    grid-template-columns: 1fr 90px auto; 
    gap: 10px;
    width: 100%;
    margin: 10px auto;
    padding: 15px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    align-items: center;
  }
  #extras-rows td {
    border: none;
    padding: 0;
    text-align: right;
    min-width: 0;
  }
  #extras-rows td:nth-child(1) {
    font-weight: bold;
    color: #fff;
    overflow-wrap: break-word;
  }
  
  #investments-table thead {
      display: none;
  }
  #inv-rows tr {
      display: grid;
      width: 100%;
      margin: 10px auto;
      padding: 15px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      gap: 10px;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
          "type   dest"
          "amount source"
          "notes  notes"
          "delete delete";
  }
  #inv-rows td { border: none; padding: 0; min-width: 0; }
  #inv-rows td:nth-child(1) { grid-area: type; }
  #inv-rows td:nth-child(2) { grid-area: dest; }
  #inv-rows td:nth-child(3) { grid-area: amount; }
  #inv-rows td:nth-child(4) { grid-area: source; }
  #inv-rows td:nth-child(5) { display: none; }
  #inv-rows td:nth-child(6) { grid-area: notes; }
  #inv-rows td:nth-child(7) { grid-area: delete; }
  #inv-rows input, #inv-rows textarea { width: 100%; }
  #inv-rows td:nth-child(7) button { width: 100%; }

  #rows {
    width:100%;
    border-spacing: 0;
    border-collapse: separate;
    direction: rtl;
  }
  #rows tr {
    display:grid;
    width: 100%;
    margin: 10px auto;
    /* --- âœ¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§ --- */
    grid-template-areas:
      "name     name    actions"
      "planned  paid    due"
      "status   status  status"
      "detailsInput detailsToggle detailsToggle"
      "detailsPanel detailsPanel detailsPanel";
    grid-template-columns: 1fr 1fr 90px; /* 3 Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 2 */
    column-gap: 10px;
    row-gap: 12px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 12px;
    align-items:start;
    overflow:hidden;
  }
  #rows thead, #rows th { display: none !important; }

  /* --- âœ¨ ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
  #rows td:nth-child(1) { grid-area: name; }
  #rows td:nth-child(2) { grid-area: planned; }
  #rows td:nth-child(3) { grid-area: paid; }
  #rows td:nth-child(4) { grid-area: due; }
  #rows td:nth-child(5) { grid-area: status; }
  #rows td:nth-child(6) { grid-area: actions; }
  
  #rows td { position:relative; padding: 0; min-width: 0; }
  #rows td::before {
    display:block; font-size: 0.85rem; font-weight: 600;
    margin-bottom: 6px; color: #cbd5e1; text-align: right;
  }

  /* --- âœ¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù†ØµÙˆØµ --- */
  #rows td:nth-child(1)::before { content: "Ø§Ù„Ù…ØµØ±ÙˆÙ"; text-align: right; }
  #rows td:nth-child(2)::before { content: "Ø§Ù„Ù…Ø®Ø·Ø·"; text-align: center; }
  #rows td:nth-child(3)::before { content: "Ø§Ù„Ù…Ø¯ÙÙˆØ¹"; text-align: center; }
  #rows td:nth-child(4)::before { content: "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"; text-align: center; }
  #rows td:nth-child(5)::before { content: "Ø§Ù„Ø­Ø§Ù„Ø©"; text-align: right; }
  #rows td:nth-child(6)::before { content: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"; text-align: center; }
  
  #rows input, #rows select, #rows textarea {
    width: 100%; max-width: 100%; padding: 8px 10px; min-width: 0;
  }

  #rows td:nth-child(1) { align-items: flex-start; } /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ù„ÙŠÙ…ÙŠÙ† */
  #rows td:nth-child(1) input { text-align: right; }
  
  #rows td:nth-child(2), 
  #rows td:nth-child(3), 
  #rows td:nth-child(4),
  #rows td:nth-child(6) {
    display:flex; flex-direction: column; align-items: center; text-align:center;
  }

  #rows td:nth-child(5) { text-align: right; padding-right: 5px; } /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† */

  .action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    width: 100%;
  }

  #rows td:nth-child(6) .btn, #rows td:nth-child(6) button { padding:8px 6px; font-size:0.9rem; }
  #rows td:nth-child(6) .is-details-btn { display:none !important; }
  #rows td.mobile-details-input::before  { content: "Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„"; text-align:center; width:100%; }
  #rows td.mobile-details-toggle::before { content: "Ø§Ù„ØªÙØ§ØµÙŠÙ„"; text-align:center; width:100%; }
  #rows td.mobile-details-toggle::after  { content: ""; }
  #rows td.mobile-details-input, #rows td.mobile-details-toggle {
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  #rows td.mobile-details-input button, #rows td.mobile-details-toggle button {
    padding:8px 10px; -webkit-appearance:none; appearance:none;
  }
  
  #rows td.mobile-details-panel {
    grid-area: detailsPanel;
    border: 1px dashed rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 10px;
    width: 100%;
    transition: opacity 0.2s, visibility 0.2s;
    visibility: hidden;
    opacity: 0;
    min-height: 120px;
  }
  #rows td.mobile-details-panel.visible {
      visibility: visible;
      opacity: 1;
  }

  #rows td.mobile-details-panel .placeholder {
    opacity: .8; font-size: .95rem; text-align: center; padding: 4px 0;
  }
  #rows td.mobile-details-panel .details-list { display:flex; flex-direction:column; gap:8px; }
  #rows td.mobile-details-panel .detail-item {
    display:grid; grid-template-columns: 1fr 9ch 34px; gap:8px; align-items:center;
  }
  #rows td.mobile-details-panel .detail-item input[type="text"] { width:100%; }
  #rows td.mobile-details-panel .detail-item input[data-role="value"] {
    width:9ch; max-width:9ch; text-align:end; direction:ltr;
  }
  #rows td.mobile-details-panel .detail-item button.del {
    background:#c0392b; color:#fff; border:none; border-radius:8px;
    width:34px; height:34px; display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:1rem;
  }
  #rows td .mobile-status-text { margin-top: 2px; font-size: .9rem; text-align:center; }
  #rows td .mobile-status-text.ok { color: #2ecc71; }
  #rows td .mobile-status-text.over { color: #e74c3c; }
  #rows td .mobile-status-text.neutral { color: #ddd; }
  #rows tr * { min-width:0; max-width:100%; }
}
</style>
</head>
<body>
Â  <h1>ğŸ’° Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</h1>

Â  <div class="card">
Â  Â  <div class="row">
Â  Â  Â  <div style="flex:1 1 200px">
Â  Â  Â  Â  <label>Ø§Ù„Ø³Ù†Ø©</label>
Â  Â  Â  Â  <input id="year-input" type="number" />
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1 1 220px">
Â  Â  Â  Â  <label>Ø§Ù„Ø´Ù‡Ø± (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
Â  Â  Â  Â  <select id="month-select">
Â  Â  Â  Â  Â  <option value="01">ÙŠÙ†Ø§ÙŠØ±</option><option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="03">Ù…Ø§Ø±Ø³</option>
Â  Â  Â  Â  Â  <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option><option value="05">Ù…Ø§ÙŠÙˆ</option><option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
Â  Â  Â  Â  Â  <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="08">Ø£ØºØ³Ø·Ø³</option><option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
Â  Â  Â  Â  Â  <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="row" style="margin-top:10px">
Â  Â  Â  <button id="save-template" class="primary">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨</button>
Â  Â  Â  <div style="flex:1 1 260px">
Â  Â  Â  Â  <label>Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</label>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <select id="templates-select" style="flex:1 1 220px"></select>
Â  Â  Â  Â  Â  <button id="apply-template" class="ghost">ØªØ·Ø¨ÙŠÙ‚</button>
Â  Â  Â  Â  Â  <button id="delete-template" class="danger">Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <button id="close-month" class="primary">ğŸ“¦ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ù‡Ø± ÙˆØ­ÙØ¸Ù‡</button>
Â  Â  Â  <button id="reset" class="danger">ØªÙØ±ÙŠØº Ø§Ù„ÙƒÙ„</button>
Â  Â  Â  <button id="export-history" class="ghost">ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ JSON</button>
Â  Â  Â  <button id="export-csv" class="ghost">ØªØµØ¯ÙŠØ± CSV</button>
Â  Â  Â  <input type="file" id="import-history" accept="application/json" style="display:none" />
Â  Â  Â  <button id="import-history-btn" class="ghost">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø±Ø´ÙŠÙ</button>
Â  Â  </div>
Â  </div>

Â  <div class="card">
Â  Â  <h3>ğŸ’µ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±Ø§ØªØ¨)</h3>
Â  Â  <div class="row" style="align-items:flex-end">
Â  Â  Â  <div style="flex:1 1 260px">
Â  Â  Â  Â  <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
Â  Â  Â  Â  <input id="salary2" type="number" placeholder="" />
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="card">
Â  Â  <h3>â• Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</h3>
Â  Â  <label>Ø§Ø³Ù… Ø§Ù„Ø¯Ø®Ù„</label>
Â  Â  <input id="extra-name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠ" />
Â  Â  <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯Ø®Ù„</label>
Â  Â  <input id="extra-amount" type="number" />
Â  Â  <button id="add-extra" class="primary" style="margin-top:10px">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„</button>
Â  Â  <table class="main-table" id="extras-table">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>Ø¯Ø®Ù„</th>
Â  Â  Â  Â  Â  <th class="col-paid">Ø§Ù„Ù…Ø¨Ù„Øº</th>
Â  Â  Â  Â  Â  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="extras-rows"></tbody>
Â  Â  </table>
Â  </div>

Â  <div class="card">
Â  Â  <h3>ğŸ§¾ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
Â  Â  <label>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
Â  Â  <div class="row" style="gap:8px">
Â  Â  Â  <select id="name" style="flex:1 1 220px">
Â  Â  Â  Â  <option>Ø³ÙƒÙ†</option><option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ù…Ø§Ø¡</option><option>Ø¥Ù†ØªØ±Ù†Øª</option><option>ØºØ§Ø²</option><option>Ø§ØªØµØ§Ù„Ø§Øª</option>
Â  Â  Â  Â  <option>Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</option><option>Ù…Ø·Ø§Ø¹Ù…</option><option>ØªØ±ÙÙŠÙ‡</option><option>ÙˆÙ‚ÙˆØ¯</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option><option>ØªØ¹Ù„ÙŠÙ…</option>
Â  Â  Â  Â  <option>ØµØ­Ø©</option><option>Ù…Ù„Ø§Ø¨Ø³</option><option>Ù‡Ø¯Ø§ÙŠØ§</option><option>Ø¬Ù…Ø¹ÙŠØ©</option><option>Ø£Ù‚Ø³Ø§Ø·</option><option>ØµØ¯Ù‚Ø§Øª</option><option>Ø£Ø®Ø±Ù‰</option>
Â  Â  Â  </select>
Â  Â  Â  <input id="name-custom" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ø£Ø®Ø±Ù‰)" style="flex:1 1 220px" />
Â  Â  Â  <button id="save-custom-cat" class="ghost">ğŸ’¾ Ø­ÙØ¸ ÙƒØ®ÙŠØ§Ø± Ø¯Ø§Ø¦Ù…</button>
Â  Â  Â  <button id="delete-cat" class="danger">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
Â  Â  </div>
Â  Â  <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®Ø·Ø·</label><input id="planned" type="number" />
Â  Â  <label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</label><input id="paid" type="number" />
Â  Â  <button id="add" type="button" class="primary" style="margin-top:12px">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
Â  Â  <table class="main-table" id="rows">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th class="col-planned">Ø§Ù„Ù…Ø®Ø·Ø·</th><th class="col-paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th class="col-due">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody></tbody>
Â  Â  </table>
Â  Â  <div class="totals">
Â  Â  Â  <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø·Ø·</div><h3 id="t_planned">0</h3></div>
Â  Â  Â  <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><h3 id="t_paid">0</h3></div>
Â  Â  Â  <div><div class="pill">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯</div><h3 id="t_due">0</h3></div>
Â  Â  Â  <div><div class="pill">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div><h3 id="t_balance">0</h3></div>
Â  Â  </div>
Â  </div>

Â  <div class="card">
Â  Â  <h3>ğŸ“ˆ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</h3>
Â  Â  <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø³ØªÙ‚Ù„Ø© ØªÙ…Ø§Ù…Ù‹Ø§ ÙˆÙ„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø£Ùˆ Ø§Ù„Ø£Ø±ØµØ¯Ø©.</p>
Â  Â  <div class="row">
Â  Â  Â  <div style="flex:1 1 220px">
Â  Â  Â  Â  <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</label><input id="inv-type" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø³Ù‡Ù…ØŒ Ø¨ÙŠØªÙƒÙˆÙŠÙ†ØŒ Ø¹Ù‚Ø§Ø±" />
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1 1 220px">
Â  Â  Â  Â  <label>Ø§Ù„ÙˆØ¬Ù‡Ø© / Ø£ÙŠÙ† Ø°Ù‡Ø¨Øª Ø§Ù„Ø£Ù…ÙˆØ§Ù„</label><input id="inv-dest" placeholder="Ù…Ø«Ø§Ù„: TeslaØŒ BTC WalletØŒ ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø¤Ø´Ø±" />
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1 1 180px">
Â  Â  Â  Â  <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</label><input id="inv-amount" type="number" />
Â  Â  Â  </div>
Â  Â  Â  <div style="flex:1 1 220px">
Â  Â  Â  Â  <label>Ù…ØµØ¯Ø± Ø§Ù„Ø£Ù…ÙˆØ§Ù„</label><input id="inv-source" placeholder="Ø±Ø§ØªØ¨ØŒ Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠØŒ Ø³Ø­Ø¨ Ù…Ù† Ø§Ø¯Ø®Ø§Ø±..." />
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª / ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
Â  Â  <textarea id="inv-notes" placeholder="ØªÙØ§ØµÙŠÙ„ Ù…Ø«Ù„: Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„ÙˆØ³ÙŠØ·ØŒ Ø±Ø³ÙˆÙ…..."></textarea>
Â  Â  <button id="add-inv" class="primary" style="margin-top:12px">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ«Ù…Ø§Ø±</button>
Â  Â  <table class="main-table" id="investments-table">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th class="col-paid">Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="inv-rows"></tbody>
Â  Â  </table>
Â  </div>

Â  <div class="card">
Â  Â  <h3>ğŸ“š Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
Â  Â  <div class="row" style="margin-bottom:10px">
Â  Â  Â  <div style="flex:1 1 220px">
Â  Â  Â  Â  <label>Ø§Ø®ØªØ± Ø´Ù‡Ø±Ù‹Ø§</label><select id="history-select"></select>
Â  Â  Â  </div>
Â  Â  Â  <button id="delete-month" class="danger">Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
Â  Â  </div>
Â  Â  <div id="history-kpis" class="totals"></div>
Â  Â  <div id="history-table-wrap"></div>
Â  Â  <div id="history-chart-wrap"><canvas id="history-chart"></canvas></div>
Â  Â  <div id="delta-chart-wrap"><canvas id="delta-chart"></canvas></div>
Â  </div>

Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <script>
Â  Â  const $=id=>document.getElementById(id);
Â  Â  const STORE_KEY='budget-mini-v5';
Â  Â  const HISTORY_KEY='budget-history-v5';
Â  Â  const TEMPLATES_KEY='budget-templates-v4';
Â  Â  const CATS_KEY='budget-custom-cats-v1';
Â  Â  const DELETED_CATS_KEY='budget-deleted-cats-v1';
Â  Â  let state={salary:0,items:[],extras:[],investments:[]};
Â  Â  const legacyStoreV4 = JSON.parse(localStorage.getItem('budget-mini-v4')||'null');
Â  Â  if(!localStorage.getItem(STORE_KEY) && legacyStoreV4){
Â  Â  Â  state = { ...legacyStoreV4, investments: legacyStoreV4.investments || [] };
Â  Â  Â  localStorage.setItem(STORE_KEY, JSON.stringify(state));
Â  Â  }
Â  Â  function ensureSelectPopulated(id, fillerFn, fallbackBuilder) {
Â  Â  Â  const sel = $(id);
Â  Â  Â  let tries = 0;
Â  Â  Â  const tick = () => {
Â  Â  Â  Â  tries++;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (sel && sel.options && sel.options.length === 0) {
Â  Â  Â  Â  Â  Â  if (typeof fillerFn === 'function') fillerFn();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (sel && sel.options && sel.options.length === 0 && typeof fallbackBuilder === 'function') {
Â  Â  Â  Â  Â  Â  const opts = fallbackBuilder();
Â  Â  Â  Â  Â  Â  if (Array.isArray(opts) && opts.length) {
Â  Â  Â  Â  Â  Â  Â  opts.forEach(o => {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = o.value;
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = o.text;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e){}
Â  Â  Â  Â  if (sel && sel.options && sel.options.length === 0 && tries < 6) {
Â  Â  Â  Â  Â  setTimeout(tick, 200);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  setTimeout(tick, 120);
Â  Â  }
Â  Â  function runEnsures(){
Â  Â  Â  ensureSelectPopulated('month-select', fillMonths, () => [
Â  Â  Â  Â  {value:'01', text:'ÙŠÙ†Ø§ÙŠØ±'},{value:'02', text:'ÙØ¨Ø±Ø§ÙŠØ±'},{value:'03', text:'Ù…Ø§Ø±Ø³'},
Â  Â  Â  Â  {value:'04', text:'Ø£Ø¨Ø±ÙŠÙ„'},{value:'05', text:'Ù…Ø§ÙŠÙˆ'},{value:'06', text:'ÙŠÙˆÙ†ÙŠÙˆ'},
Â  Â  Â  Â  {value:'07', text:'ÙŠÙˆÙ„ÙŠÙˆ'},{value:'08', text:'Ø£ØºØ³Ø·Ø³'},{value:'09', text:'Ø³Ø¨ØªÙ…Ø¨Ø±'},
Â  Â  Â  Â  {value:'10', text:'Ø£ÙƒØªÙˆØ¨Ø±'},{value:'11', text:'Ù†ÙˆÙÙ…Ø¨Ø±'},{value:'12', text:'Ø¯ÙŠØ³Ù…Ø¨Ø±'},
Â  Â  Â  ]);
Â  Â  Â  ensureSelectPopulated('name', refreshCats, () => (defaultCats||[]).map(c=>({value:c,text:c})) );
Â  Â  Â  ensureSelectPopulated('templates-select', refreshTemplates, () => [{value:'', text:'â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ â€”'}]);
Â  Â  Â  ensureSelectPopulated('history-select', refreshHistorySelect, () => [{value:'', text:'â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙ â€”'}]);
Â  Â  }
Â  Â  function ensureCatsRetries() {
Â  Â  Â  const sel = $('name');
Â  Â  Â  let attempts = 0;
Â  Â  Â  const tick = () => {
Â  Â  Â  Â  attempts++;
Â  Â  Â  Â  if (sel && sel.options && sel.options.length === 0) {
Â  Â  Â  Â  Â  try { refreshCats(); } catch(e){}
Â  Â  Â  Â  }
Â  Â  Â  Â  if (sel && sel.options && sel.options.length === 0 && attempts < 5) {
Â  Â  Â  Â  Â  setTimeout(tick, 200);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  setTimeout(tick, 150);
Â  Â  }
Â  Â  let budgetHistory = load(HISTORY_KEY) || {};
Â  Â  const legacyHistoryV4 = JSON.parse(localStorage.getItem('budget-history-v4')||'null');
Â  Â  if(!Object.keys(budgetHistory).length && legacyHistoryV4){
Â  Â  Â  budgetHistory = legacyHistoryV4; save(HISTORY_KEY,budgetHistory);
Â  Â  }
Â  Â  let templates = load(TEMPLATES_KEY) || {};
Â  Â  let customCats = load(CATS_KEY) || [];
Â  Â  let deletedCats = load(DELETED_CATS_KEY) || [];
Â  Â  let historyChart=null, deltaChart=null;
Â  Â  function load(key){ try{ return JSON.parse(localStorage.getItem(key)||'null') }catch{ return null } }
Â  Â  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
Â  Â  function persist(){ save(STORE_KEY,state) }
Â  Â  function normalizeCat(s){ return (s||'').trim().replace(/\s+/g,' '); }
Â  Â  function monthNow(){ const d=new Date();const m=(d.getMonth()+1).toString().padStart(2,'0');return `${d.getFullYear()}-${m}`; }
Â  Â  const months = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
Â  Â  function fillMonths(){
Â  Â  Â  const sel=$('month-select'); sel.innerHTML='';
Â  Â  Â  months.forEach((m,i)=>{ const v=(i+1).toString().padStart(2,'0'); const opt=document.createElement('option'); opt.value=v; opt.textContent=m; sel.appendChild(opt); });
Â  Â  }
Â  Â  function currentMonthName(){
Â  Â  Â  try {
Â  Â  Â  Â  const idx = Math.max(0, (parseInt($('month-select').value || (new Date().getMonth()+1), 10) - 1));
Â  Â  Â  Â  return months[idx] || '';
Â  Â  Â  } catch { return ''; }
Â  Â  }
Â  Â  const defaultCats=['Ø³ÙƒÙ†','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ù…Ø§Ø¡','Ø¥Ù†ØªØ±Ù†Øª','ØºØ§Ø²','Ø§ØªØµØ§Ù„Ø§Øª','Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª','Ù…Ø·Ø§Ø¹Ù…','ØªØ±ÙÙŠÙ‡','ÙˆÙ‚ÙˆØ¯','Ù…ÙˆØ§ØµÙ„Ø§Øª','ØªØ¹Ù„ÙŠÙ…','ØµØ­Ø©','Ù…Ù„Ø§Ø¨Ø³','Ù‡Ø¯Ø§ÙŠØ§','Ø¬Ù…Ø¹ÙŠØ©','Ø£Ù‚Ø³Ø§Ø·','ØµØ¯Ù‚Ø§Øª','Ø£Ø®Ø±Ù‰'];
Â  Â  function visibleCats(){
Â  Â  Â  const delSet = new Set((deletedCats||[]).map(normalizeCat));
Â  Â  Â  return [...new Set([...defaultCats, ...customCats])].filter(c=>!delSet.has(normalizeCat(c)));
Â  Â  }
Â  Â  function refreshCats(){
Â  Â  Â  const sel=$('name'); sel.innerHTML='';
Â  Â  Â  let cats = visibleCats();
Â  Â  Â  if(!Array.isArray(cats) || cats.length === 0){ cats = [...defaultCats]; }
Â  Â  Â  cats.forEach(c=>{
Â  Â  Â  Â  const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
Â  Â  Â  });
Â  Â  Â  sel.value = cats.includes('Ø£Ø®Ø±Ù‰') ? 'Ø£Ø®Ø±Ù‰' : (cats[0]||'');
Â  Â  }
Â  Â  function addCustomCatIfNeeded(nameRaw){
Â  Â  Â  const name = normalizeCat(nameRaw);
Â  Â  Â  if(!name || name==='Ø£Ø®Ø±Ù‰') return;
Â  Â  Â  if(!customCats.map(normalizeCat).includes(name)){
Â  Â  Â  Â  customCats.push(name);
Â  Â  Â  Â  save(CATS_KEY, customCats);
Â  Â  Â  }
Â  Â  Â  deletedCats = (deletedCats||[]).map(normalizeCat).filter(d=>d!==name);
Â  Â  Â  save(DELETED_CATS_KEY, deletedCats);
Â  Â  Â  refreshCats();
Â  Â  Â  $('name').value = name;
Â  Â  }
Â  Â  function deleteSelectedCat(){
Â  Â  Â  const c = normalizeCat($('name').value);
Â  Â  Â  if(!c){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø© Ù…Ø­Ø¯Ø¯Ø©'); return; }
Â  Â  Â  if(c==='Ø£Ø®Ø±Ù‰'){ alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ÙØ¦Ø© "Ø£Ø®Ø±Ù‰"'); return; }
Â  Â  Â  if(!(deletedCats||[]).map(normalizeCat).includes(c)){
Â  Â  Â  Â  deletedCats.push(c);
Â  Â  Â  }
Â  Â  Â  save(DELETED_CATS_KEY, deletedCats);
Â  Â  Â  refreshCats();
Â  Â  Â  alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© "${c}" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ù„Ø§ ØªØªØ£Ø«Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙØ¶Ø§ÙØ© Ø³Ø§Ø¨Ù‚Ù‹Ø§.`);
Â  Â  }
Â  Â  function statusOf(i){
Â  Â  Â  if((+i.paid||0) >= (+i.planned||0) && (+i.planned||0) > 0) return {text:'Ù…Ø¯ÙÙˆØ¹', cls:'Ù…Ø¯ÙÙˆØ¹'};
Â  Â  Â  if((+i.paid||0) > 0 && (+i.paid||0) < (+i.planned||0)) return {text:'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ', cls:'Ù…Ø¯ÙÙˆØ¹-Ø¬Ø²Ø¦ÙŠ'};
Â  Â  Â  return {text:'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', cls:'ØºÙŠØ±-Ù…Ø¯ÙÙˆØ¹'};
Â  Â  }
Â  Â  function updateTotals(){
Â  Â  Â  let tPlanned=0,tPaid=0;
Â  Â  Â  state.items.forEach(i=>{ tPlanned+=(+i.planned||0); tPaid+=(+i.paid||0); });
Â  Â  Â  const extrasSum = state.extras.reduce((a,e)=>a+(+e.amount||0),0);
Â  Â  Â  $('t_planned').textContent=tPlanned;
Â  Â  Â  $('t_paid').textContent=tPaid;
Â  Â  Â  $('t_due').textContent=Math.max(0,tPlanned-tPaid);
Â  Â  Â  $('t_balance').textContent=(+state.salary||0)+extrasSum - tPaid;
Â  Â  Â  const sal2=$('salary2'); if(sal2) sal2.value = state.salary ? state.salary : '';
Â  Â  }
Â  Â  function renderExpenses(){
Â  Â  Â  const tb=$('rows').querySelector('tbody'); tb.innerHTML='';
Â  Â  Â  state.items.forEach((it)=>{
Â  Â  Â  Â  const st=statusOf(it);
Â  Â  Â  Â  const tr=document.createElement('tr');
Â  Â  Â  Â Â 
Â  Â  Â  Â  tr.innerHTML=`
Â  Â  Â  Â  Â  <td><input type="text" value="${it.name||''}" class="name-input"></td>
Â  Â  Â  Â  Â  <td class="col-planned"><input type="number" value="${it.planned||0}" class="planned-input"></td>
Â  Â  Â  Â  Â  <td class="col-paid"><input type="number" value="${it.paid||0}" class="paid-input"></td>
Â  Â  Â  Â  Â  <td class="col-due due">${Math.max(0,(+it.planned||0)-(+it.paid||0))}</td>
Â  Â  Â  Â  Â  <td class="status ${st.cls}">${st.text}</td>
Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <div class="action-buttons">
Â  Â  Â  Â  Â  Â  Â  <button class="primary pay-one">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
Â  Â  Â  Â  Â  Â  Â  <button class="danger del">Ø­Ø°Ù</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="ghost sub-btn" style="display:none;">â• ØªÙØµÙŠÙ„</button>
Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  `;

Â  Â  Â  Â  const nameInp=tr.querySelector('.name-input');
Â  Â  Â  Â  const pInp=tr.querySelector('.planned-input');
Â  Â  Â  Â  const paInp=tr.querySelector('.paid-input');
Â  Â  Â  Â  const dueCell=tr.querySelector('.due');
Â  Â  Â  Â  const statusCell=tr.querySelector('.status');
Â  Â  Â  Â  const payBtn=tr.querySelector('.pay-one');
Â  Â  Â  Â  const delBtn=tr.querySelector('.del');
Â  Â  Â  Â  const subBtn=tr.querySelector('.sub-btn');
Â  Â  Â  Â  if(!it.subItems) it.subItems=[];

Â  Â  Â  Â  function refreshRow(){
Â  Â  Â  Â  Â  const st=statusOf(it);
Â  Â  Â  Â  Â  dueCell.textContent=Math.max(0,(+it.planned||0)-(+it.paid||0));
Â  Â  Â  Â  Â  statusCell.textContent=st.text;
Â  Â  Â  Â  Â  statusCell.className='status '+st.cls;
Â  Â  Â  Â  Â  updateTotals(); persist();
Â  Â  Â  Â  }

Â  Â  Â  Â  nameInp.addEventListener('input',e=>{ it.name=normalizeCat(e.target.value); persist(); });
Â  Â  Â  Â  pInp.addEventListener('input',e=>{ it.planned=+e.target.value||0; refreshRow(); });
Â  Â  Â  Â  paInp.addEventListener('input',e=>{ it.paid=+e.target.value||0; refreshRow(); });
Â  Â  Â  Â  payBtn.addEventListener('click',()=>{
Â  Â  Â  Â  Â  it.paid=+it.planned||0;
Â  Â  Â  Â  Â  paInp.value=it.paid;
Â  Â  Â  Â  Â  refreshRow();
Â  Â  Â  Â  });
Â  Â  Â  Â  delBtn.addEventListener('click',()=>{
Â  Â  Â  Â  Â  state.items = state.items.filter(x=>x!==it);
Â  Â  Â  Â  Â  renderExpenses(); updateTotals(); persist();
Â  Â  Â  Â  });
Â  Â  Â  Â  tb.appendChild(tr);
Â  Â  Â  Â  if (it.subItems && it.subItems.length) {
Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  const cell = document.createElement('td');
Â  Â  Â  Â  Â  cell.colSpan = 6;
Â  Â  Â  Â  Â  const subTable = document.createElement('table');
Â  Â  Â  Â  Â  subTable.className = 'sub-table';
Â  Â  Â  Â  Â  subTable.innerHTML = `
Â  Â  Â  Â  Â  Â  <thead><tr><th>Ø§Ù„ØªÙØµÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  const subBody = subTable.querySelector('tbody');
Â  Â  Â  Â  Â  it.subItems.forEach((s, idx) => {
Â  Â  Â  Â  Â  Â  const subTr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  subTr.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <td>${s.name}</td>
Â  Â  Â  Â  Â  Â  Â  <td>${s.amount}</td>
Â  Â  Â  Â  Â  Â  Â  <td><button class="danger">âŒ Ø­Ø°Ù</button></td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  subTr.querySelector('button').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  it.subItems.splice(idx, 1);
Â  Â  Â  Â  Â  Â  Â  it.paid = Math.max(0, (+it.paid||0) - (+s.amount||0));
Â  Â  Â  Â  Â  Â  Â  renderExpenses(); updateTotals(); persist();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  subBody.appendChild(subTr);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  cell.appendChild(subTable);
Â  Â  Â  Â  Â  row.appendChild(cell);
Â  Â  Â  Â  Â  tb.appendChild(row);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  Â  function renderExtras(){
Â  Â  Â  const tb=$('extras-rows'); tb.innerHTML='';
Â  Â  Â  state.extras.forEach((ex, idx)=>{
Â  Â  Â  Â  const tr=document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${ex.name}</td>
Â  Â  Â  Â  Â  <td class="col-paid"><input type="number" value="${ex.amount||0}" class="extra-amount-input"></td>
Â  Â  Â  Â  Â  <td><button class="danger del-extra">Ø­Ø°Ù</button></td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  const amountInp = tr.querySelector('.extra-amount-input');
Â  Â  Â  Â  const delBtn = tr.querySelector('.del-extra');
Â  Â  Â  Â  amountInp.addEventListener('input', e=>{
Â  Â  Â  Â  Â  ex.amount = +e.target.value || 0;
Â  Â  Â  Â  Â  updateTotals(); persist();
Â  Â  Â  Â  });
Â  Â  Â  Â  delBtn.addEventListener('click',()=>{
Â  Â  Â  Â  Â  state.extras.splice(idx,1);
Â  Â  Â  Â  Â  renderExtras(); updateTotals(); persist();
Â  Â  Â  Â  });
Â  Â  Â  Â  tb.appendChild(tr);
Â  Â  Â  });
Â  Â  }
Â  Â  function renderInvestments(){
Â  Â  Â  const tb=$('inv-rows'); if(!tb) return; tb.innerHTML='';
Â  Â  Â  state.investments.forEach((inv, idx)=>{
Â  Â  Â  Â  const tr=document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td><input type="text" value="${inv.type||''}" class="inv-type-input"></td>
Â  Â  Â  Â  Â  <td><input type="text" value="${inv.dest||''}" class="inv-dest-input"></td>
Â  Â  Â  Â  Â  <td class="col-paid"><input type="number" value="${inv.amount||0}" class="inv-amount-input"></td>
Â  Â  Â  Â  Â  <td><input type="text" value="${inv.source||''}" class="inv-source-input"></td>
Â  Â  Â  Â  Â  <td><input type="text" value="${inv.addedMonth||''}" class="inv-month-input" readonly></td>
Â  Â  Â  Â  Â  <td><textarea class="inv-notes-input" style="min-height:48px">${inv.notes||''}</textarea></td>
Â  Â  Â  Â  Â  <td><button class="danger del-inv">Ø­Ø°Ù</button></td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tr.querySelector('.inv-type-input').addEventListener('input',e=>{ inv.type=normalizeCat(e.target.value); persist(); });
Â  Â  Â  Â  tr.querySelector('.inv-dest-input').addEventListener('input',e=>{ inv.dest=normalizeCat(e.target.value); persist(); });
Â  Â  Â  Â  tr.querySelector('.inv-amount-input').addEventListener('input',e=>{ inv.amount=+e.target.value||0; persist(); });
Â  Â  Â  Â  tr.querySelector('.inv-source-input').addEventListener('input',e=>{ inv.source=normalizeCat(e.target.value); persist(); });
Â  Â  Â  Â  tr.querySelector('.inv-notes-input').addEventListener('input',e=>{ inv.notes=e.target.value; persist(); });
Â  Â  Â  Â  tr.querySelector('.del-inv').addEventListener('click',()=>{
Â  Â  Â  Â  Â  state.investments.splice(idx,1);
Â  Â  Â  Â  Â  renderInvestments(); persist();
Â  Â  Â  Â  });
Â  Â  Â  Â  tb.appendChild(tr);
Â  Â  Â  });
Â  Â  }
Â  Â  function addInvestment(){
Â  Â  Â  const type = normalizeCat($('inv-type').value||'');
Â  Â  Â  const dest = normalizeCat($('inv-dest').value||'');
Â  Â  Â  const amount = +($('inv-amount').value||0);
Â  Â  Â  const source = normalizeCat($('inv-source').value||'');
Â  Â  Â  const notes = $('inv-notes').value||'';
Â  Â  Â  if(!type || !dest || amount<=0){ alert('Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº.'); return; }
Â  Â  Â  const addedMonth = currentMonthName();
Â  Â  Â  state.investments.push({type,dest,amount,source,notes,addedMonth});
Â  Â  Â  $('inv-type').value=''; $('inv-dest').value=''; $('inv-amount').value=''; $('inv-source').value=''; $('inv-notes').value='';
Â  Â  Â  renderInvestments(); persist();
Â  Â  Â  alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± âœ…');
Â  Â  }
Â  Â  function addItem(){
Â  Â  Â  try{ if(document.activeElement) document.activeElement.blur(); }catch{}
Â  Â  Â  const selEl = $('name'); const selVal = selEl && selEl.value ? selEl.value : '';
Â  Â  Â  const customRaw = $('name-custom').value || '';
Â  Â  Â  const custom = normalizeCat(customRaw);
Â  Â  Â  const chosen = (selVal === 'Ø£Ø®Ø±Ù‰' && custom) ? custom : selVal;
Â  Â  Â  addCustomCatIfNeeded(chosen);
Â  Â  Â  const plannedVal = +($('planned').value||0); const paidVal = +($('paid').value||0);
Â  Â  Â  if(!chosen && plannedVal===0 && paidVal===0){ alert('Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø§ÙƒØªØ¨ Ù…Ø¨Ù„ØºÙ‹Ø§.'); return; }
Â  Â  Â  state.items.push({ name: chosen || 'ØºÙŠØ± Ù…Ø³Ù…Ù‰', planned:plannedVal, paid:paidVal, subItems:[] });
Â  Â  Â  $('name-custom').value=''; $('planned').value=''; $('paid').value='';
Â  Â  Â  renderExpenses(); updateTotals(); persist();
Â  Â  }
Â  Â  function saveCurrentAsTemplate(){
Â  Â  Â  const tName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨:'); if(!tName) return;
Â  Â  Â  const itemsOnly = state.items.map(i => ({
Â  Â  Â  Â  name: i.name,
Â  Â  Â  Â  planned: +i.planned || 0,
Â  Â  Â  Â  paid: +i.paid || 0,
Â  Â  Â  Â  subItems: Array.isArray(i.subItems) ? i.subItems.map(s => ({name:s.name, amount:+s.amount||0})) : []
Â  Â  Â  }));
Â  Â  Â  templates[tName] = { items: itemsOnly, salary: +state.salary || 0 };
Â  Â  Â  save(TEMPLATES_KEY, templates);
Â  Â  Â  refreshTemplates();
Â  Â  Â  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ âœ…');
Â  Â  }
Â  Â  function refreshTemplates(){
Â  Â  Â  const sel=$('templates-select'); sel.innerHTML='';
Â  Â  Â  Object.keys(templates).forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=k; sel.appendChild(opt); });
Â  Â  }
Â  Â  function applyTemplate(){
Â  Â  Â  const k=$('templates-select').value;
Â  Â  Â  if(!k || !templates[k]) return;
Â  Â  Â  state.items = JSON.parse(JSON.stringify(templates[k].items||[]));
Â  Â  Â  state.salary = +templates[k].salary || 0;
Â  Â  Â  renderExpenses(); renderExtras(); updateTotals(); persist();
Â  Â  }
Â  Â  function deleteTemplate(){
Â  Â  Â  const k=$('templates-select').value; if(!k) return;
Â  Â  Â  if(confirm('Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ')){ delete templates[k]; save(TEMPLATES_KEY, templates); refreshTemplates(); }
Â  Â  }
Â  Â  function addExtra(){
Â  Â  Â  const name = normalizeCat($('extra-name').value||'');
Â  Â  Â  const amount = +$('extra-amount').value||0;
Â  Â  Â  if(!name || amount<=0){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯Ø®Ù„ ÙˆÙ…Ø¨Ù„ØºÙ‡'); return; }
Â  Â  Â  state.extras.push({name, amount});
Â  Â  Â  $('extra-name').value=''; $('extra-amount').value='';
Â  Â  Â  renderExtras(); updateTotals(); persist();
Â  Â  }
Â  Â  function computeTotalsFor(s){
Â  Â  Â  const planned=s.items.reduce((a,b)=>a+(+b.planned||0),0);
Â  Â  Â  const paid=s.items.reduce((a,b)=>a+(+b.paid||0),0);
Â  Â  Â  const due=Math.max(0, planned-paid);
Â  Â  Â  const extrasSum = (s.extras||[]).reduce((a,e)=>a+(+e.amount||0),0);
Â  Â  Â  const balance=(+s.salary||0)+extrasSum - paid;
Â  Â  Â  const completed=s.items.filter(i=>(+i.paid||0) >= (+i.planned||0) && (+i.planned||0) > 0).length;
Â  Â  Â  const partial=s.items.filter(i=>(+i.paid||0) > 0 && (+i.paid||0) < (+i.planned||0)).length;
Â  Â  Â  const zeroPaid=s.items.filter(i=>!(+i.paid||0)).length;
Â  Â  Â  const execRate= planned>0 ? Math.round((paid/planned)*100) : 0;
Â  Â  Â  const invested=(s.investments||[]).reduce((a,x)=>a+(+x.amount||0),0);
Â  Â  Â  return {planned, paid, due, balance, completed, partial, zeroPaid, execRate, invested};
Â  Â  }
Â  Â  function periodFromInputs(){
Â  Â  Â  const y = ($('year-input').value||'').trim();
Â  Â  Â  const m = $('month-select').value || '';
Â  Â  Â  if(!/^[0-9]{4}$/.test(y)){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø© Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©'); return null; }
Â  Â  Â  return `${y}-${m}`;
Â  Â  }
Â  Â  function monthIndicator(totals){
Â  Â  Â  if(totals.paid < totals.planned) return 'ğŸŸ¢';
Â  Â  Â  if(totals.paid === totals.planned) return 'âœ…';
Â  Â  Â  return 'ğŸ”´';
Â  Â  }
Â  Â  function closeMonth(){
Â  Â  Â  const period = periodFromInputs() || monthNow();
Â  Â  Â  if(!state.items.length && !state.extras.length && !state.investments.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§'); return; }
Â  Â  Â  const snapshot = {
Â  Â  Â  Â  period,
Â  Â  Â  Â  salary:+state.salary||0,
Â  Â  Â  Â  extras: state.extras||[],
Â  Â  Â  Â  items: state.items.map(i=>({name:i.name,planned:+i.planned||0,paid:+i.paid||0,subItems:i.subItems||[]})),
Â  Â  Â  Â  investments: (state.investments||[]).map(x=>({
Â  Â  Â  Â  Â  type:x.type,
Â  Â  Â  Â  Â  dest:x.dest,
Â  Â  Â  Â  Â  amount:+x.amount||0,
Â  Â  Â  Â  Â  source:x.source||'',
Â  Â  Â  Â  Â  notes:x.notes||'',
Â  Â  Â  Â  Â  addedMonth: x.addedMonth || currentMonthName()
Â  Â  Â  Â  }))
Â  Â  Â  };
Â  Â  Â  snapshot.totals = computeTotalsFor(snapshot);
Â  Â  Â  budgetHistory[period]=snapshot; save(HISTORY_KEY, budgetHistory);
Â  Â  Â  refreshHistorySelect(period); renderHistory(); renderHistoryChart(); renderDeltaChart();
Â  Â  Â  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ âœ…');
Â  Â  }
Â  Â  function refreshHistorySelect(selectPeriod){
Â  Â  Â  const sel=$('history-select'); sel.innerHTML='';
Â  Â  Â  const periods=Object.keys(budgetHistory).sort().reverse();
Â  Â  Â  periods.forEach(p=>{
Â  Â  Â  Â  const t = budgetHistory[p]?.totals || {planned:0,paid:0};
Â  Â  Â  Â  const mark = monthIndicator(t);
Â  Â  Â  Â  const opt=document.createElement('option'); opt.value=p; opt.textContent=`${p} ${mark}`; sel.appendChild(opt);
Â  Â  Â  });
Â  Â  Â  if(selectPeriod && periods.includes(selectPeriod)) sel.value=selectPeriod;
Â  Â  }
Â  Â  function renderHistory(){
Â  Â  Â  const sel=$('history-select'); const wrap=$('history-table-wrap'); const kpis=$('history-kpis');
Â  Â  Â  if(!sel || !wrap || !kpis) return;
Â  Â  Â  const p=sel.value; if(!p || !budgetHistory[p]){ wrap.innerHTML='<p class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯.</p>'; kpis.innerHTML=''; return; }
Â  Â  Â  const snap=budgetHistory[p]; const t=snap.totals;
Â  Â  Â  kpis.innerHTML=`
Â  Â  Â  Â  <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø·Ø·</div><h3>${t.planned}</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><h3>${t.paid}</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</div><h3>${t.execRate}%</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ø¨Ù†ÙˆØ¯ Ù…Ø¯ÙÙˆØ¹Ø©</div><h3>${t.completed}</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠ</div><h3>${t.partial}</h3></div>
Â  Â  Â  Â  <div><div class="pill">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</div><h3>${t.zeroPaid}</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><h3>${t.due}</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div><h3>${t.balance}</h3></div>
Â  Â  Â  Â  <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</div><h3>${t.invested||0}</h3></div>
Â  Â  Â  `;
Â  Â  Â  let rows='';
Â  Â  Â  snap.items.forEach(i=>{
Â  Â  Â  Â  const due=Math.max(0,(+i.planned||0) - (+i.paid||0));
Â  Â  Â  Â  const st = (+i.paid||0) >= (+i.planned||0) && (+i.planned||0) > 0 ? 'Ù…Ø¯ÙÙˆØ¹' : ((+i.paid||0)>0 ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹');
Â  Â  Â  Â  rows += `<tr><td>${i.name}</td><td>${i.planned}</td><td>${i.paid}</td><td>${due}</td><td>${st}</td></tr>`;
Â  Â  Â  Â  if(i.subItems && i.subItems.length){
Â  Â  Â  Â  Â  i.subItems.forEach(s=>{ rows+=`<tr><td>â†³ ${s.name}</td><td colspan="4">${s.amount}</td></tr>` });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  const exSum = (s.extras||[]).reduce((a,e)=>a+(+e.amount||0),0);
Â  Â  Â  if(exSum>0){
Â  Â  Â  Â  rows += `<tr><td><span class="pill">Ø¯Ø®Ù„</span> Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</td><td>â€”</td><td>${exSum}</td><td>â€”</td><td>Ø¯Ø®Ù„</td></tr>`;
Â  Â  Â  }
Â  Â  Â  let invRows='';
Â  Â  Â  const invs = snap.investments||[];
Â  Â  Â  const invTotal = invs.reduce((a,x)=>a+(+x.amount||0),0);
Â  Â  Â  if(invs.length){
Â  Â  Â  Â  invs.forEach(x=>{
Â  Â  Â  Â  Â  invRows += `<tr>
Â  Â  Â  Â  Â  Â  <td>${x.type||''}</td>
Â  Â  Â  Â  Â  Â  <td>${x.dest||''}</td>
Â  Â  Â  Â  Â  Â  <td>${x.amount||0}</td>
Â  Â  Â  Â  Â  Â  <td>${x.source||''}</td>
Â  Â  Â  Â  Â  Â  <td>${x.addedMonth||''}</td>
Â  Â  Â  Â  Â  Â  <td>${(x.notes||'').replace(/</g,'&lt;')}</td>
Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  invRows += `<tr><td colspan="2"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td><td><strong>${invTotal}</strong></td><td colspan="3">â€”</td></tr>`;
Â  Â  Â  } else {
Â  Â  Â  Â  invRows = `<tr><td colspan="6" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`;
Â  Â  Â  }
Â  Â  Â  wrap.innerHTML = `
Â  Â  Â  Â  <h4 style="margin-top:0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
Â  Â  Â  Â  <table class="main-table">
Â  Â  Â  Â  Â  <thead><tr><th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„Ù…Ø®Ø·Ø·</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
Â  Â  Â  Â  Â  <tbody>${rows}</tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  Â  <h4 style="margin-top:20px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</h4>
Â  Â  Â  Â  <table class="main-table">
Â  Â  Â  Â  Â  <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead>
Â  Â  Â  Â  Â  <tbody>${invRows}</tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  `;
Â  Â  Â  renderHistoryChart(); renderDeltaChart();
Â  Â  }
Â  Â  function buildSeries(){
Â  Â  Â  const hist = budgetHistory || {};
Â  Â  Â  const periods = Object.keys(hist).sort();
Â  Â  Â  const labels=[], planned=[], paid=[], execRate=[];
Â  Â  Â  periods.forEach(p=>{
Â  Â  Â  Â  const t=hist[p]?.totals; if(!t) return;
Â  Â  Â  Â  labels.push(p);
Â  Â  Â  Â  planned.push(+t.planned||0);
Â  Â  Â  Â  paid.push(+t.paid||0);
Â  Â  Â  Â  execRate.push((+t.planned||0)>0? Math.round((+t.paid/+t.planned)*100):0);
Â  Â  Â  });
Â  Â  Â  return {labels, planned, paid, execRate};
Â  Â  }
Â  Â  function buildBalance(){
Â  Â  Â  const hist = budgetHistory || {};
Â  Â  Â  const periods = Object.keys(hist).sort();
Â  Â  Â  const labels=[], balance=[], colors=[];
Â  Â  Â  periods.forEach(p=>{
Â  Â  Â  Â  const t=hist[p]?.totals; if(!t) return;
Â  Â  Â  Â  const b = (+t.balance||0);
Â  Â  Â  Â  labels.push(p);
Â  Â  Â  Â  balance.push(b);
Â  Â  Â  Â  colors.push(b>=0 ? 'rgba(34,197,94,0.85)' : 'rgba(239,68,68,0.85)');
Â  Â  Â  });
Â  Â  Â  return {labels, balance, colors};
Â  Â  }
Â  Â  function renderHistoryChart(){
Â  Â  Â  const ctx=$('history-chart'); if(!ctx) return;
Â  Â  Â  const {labels, planned, paid, execRate} = buildSeries();
Â  Â  Â  if(historyChart){ historyChart.destroy(); historyChart=null; }
Â  Â  Â  if(!labels.length) return;
Â  Â  Â  historyChart = new Chart(ctx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels,
Â  Â  Â  Â  Â  datasets: [
Â  Â  Â  Â  Â  Â  { type: 'bar', label: 'Ø§Ù„Ù…Ø®Ø·Ø·', data: planned, borderWidth: 1 },
Â  Â  Â  Â  Â  Â  { type: 'bar', label: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹', data: paid, borderWidth: 1 },
Â  Â  Â  Â  Â  Â  { type: 'line', label: 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ° %', data: execRate, yAxisID: 'y1', tension: 0.3, borderWidth: 2, pointRadius: 3 }
Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  interaction: { mode: 'index', intersect: false },
Â  Â  Â  Â  Â  plugins: { legend: { position: 'top' } },
Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  y: { beginAtZero: true, title: { display: true, text: 'Ø¯Ø±Ù‡Ù…' } },
Â  Â  Â  Â  Â  Â  y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: v => v + '%' }, title: { display: true, text: 'Ùª' }, suggestedMax: 120 }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  Â  function renderDeltaChart(){
Â  Â  Â  const ctx=$('delta-chart'); if(!ctx) return;
Â  Â  Â  const {labels, balance, colors} = buildBalance();
Â  Â  Â  if(deltaChart){ deltaChart.destroy(); deltaChart=null; }
Â  Â  Â  if(!labels.length) return;
Â  Â  Â  const minVal = Math.min(0, ...balance);
Â  Â  Â  const maxVal = Math.max(0, ...balance);
Â  Â  Â  const maxAbs = Math.max(Math.abs(minVal), Math.abs(maxVal));
Â  Â  Â  deltaChart = new Chart(ctx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels,
Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  label: 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø±Ø§ØªØ¨ + Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ - Ø§Ù„Ù…Ø¯ÙÙˆØ¹) â€” 0 = Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„',
Â  Â  Â  Â  Â  Â  data: balance,
Â  Â  Â  Â  Â  Â  backgroundColor: colors
Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  plugins: { legend: { display: true } },
Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  suggestedMin: -maxAbs,
Â  Â  Â  Â  Â  Â  Â  suggestedMax:Â  maxAbs,
Â  Â  Â  Â  Â  Â  Â  title: { display: true, text: 'Ø¯Ø±Ù‡Ù…' },
Â  Â  Â  Â  Â  Â  Â  grid: { drawTicks: true }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  interaction: { mode: 'index', intersect: false }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  Â  function exportHistoryJSON(){ const blob=new Blob([JSON.stringify(budgetHistory,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='budget-history.json'; a.click(); URL.revokeObjectURL(url); }
Â  Â  function exportCSV(){
Â  Â  Â  const periods=Object.keys(budgetHistory).sort();
Â  Â  Â  let csv='period,category,planned,paid,due,status\n';
Â  Â  Â  periods.forEach(p=>{
Â  Â  Â  Â  const snap=budgetHistory[p];
Â  Â  Â  Â  snap.items.forEach(i=>{
Â  Â  Â  Â  Â  const due=Math.max(0,(+i.planned||0)-(+i.paid||0));
Â  Â  Â  Â  Â  const status=((+i.paid||0) >= (+i.planned||0) && (+i.planned||0)>0)?'paid':((+i.paid||0)>0?'partial':'unpaid');
Â  Â  Â  Â  Â  csv += `${p},"${i.name}",${i.planned},${i.paid},${due},${status}\n`;
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='budget-history.csv'; a.click(); URL.revokeObjectURL(url);
Â  Â  }
Â  Â  function importHistory(){
Â  Â  Â  const fileInput=$('import-history'); const file=fileInput.files?.[0]; if(!file) return;
Â  Â  Â  const reader=new FileReader();
Â  Â  Â  reader.onload=()=>{ try{ const data=JSON.parse(reader.result); budgetHistory=data||{}; save(HISTORY_KEY,budgetHistory); refreshHistorySelect(); renderHistory(); renderHistoryChart(); renderDeltaChart(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…'); }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } };
Â  Â  Â  reader.readAsText(file);
Â  Â  }
Â  Â  function bind(){
Â  Â  Â  function syncSalary(val){
Â  Â  Â  Â  state.salary = +val || 0;
Â  Â  Â  Â  updateTotals(); persist();
Â  Â  Â  }
Â  Â  Â  const sal2=$('salary2'); if(sal2) sal2.addEventListener('input', e=> syncSalary(e.target.value));
Â  Â  Â  $('save-custom-cat').addEventListener('click', ()=>{
Â  Â  Â  Â  const custom = normalizeCat($('name-custom').value||'');
Â  Â  Â  Â  if(!custom){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
Â  Â  Â  Â  addCustomCatIfNeeded(custom);
Â  Â  Â  Â  $('name-custom').value='';
Â  Â  Â  Â  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø© Ø¶Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª âœ…');
Â  Â  Â  });
Â  Â  Â  $('delete-cat').addEventListener('click', deleteSelectedCat);
Â  Â  Â Â 
Â  Â  Â  $('add').addEventListener('click', addItem);
Â  Â  Â Â 
Â  Â  Â  $('add-extra').addEventListener('click', addExtra);
Â  Â  Â  $('add-inv').addEventListener('click', addInvestment);
Â  Â  Â  $('save-template').addEventListener('click', saveCurrentAsTemplate);
Â  Â  Â  $('apply-template').addEventListener('click', applyTemplate);
Â  Â  Â  $('delete-template').addEventListener('click', deleteTemplate);
Â  Â  Â  $('close-month').addEventListener('click', closeMonth);
Â  Â  Â  $('history-select').addEventListener('change', ()=>{ renderHistory(); });
Â  Â  Â  $('delete-month').addEventListener('click', deleteSelectedMonth);
Â  Â  Â  $('reset').addEventListener('click', ()=>{ if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ±ÙŠØºØŸ')){ state={salary:0,items:[],extras:[],investments:[]}; renderExpenses(); renderExtras(); renderInvestments(); updateTotals(); persist(); } });
Â  Â  Â  $('export-history').addEventListener('click', exportHistoryJSON);
Â  Â  Â  $('export-csv').addEventListener('click', exportCSV);
Â  Â  Â  $('import-history-btn').addEventListener('click', ()=> $('import-history').click());
Â  Â  Â  $('import-history').addEventListener('change', importHistory);
Â  Â  }
Â  Â  function deleteSelectedMonth(){
Â  Â  Â  const sel=$('history-select'); if(!sel || !sel.value) return;
Â  Â  Â  if(confirm(`Ø­Ø°Ù Ø´Ù‡Ø± ${sel.value} Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ`)){
Â  Â  Â  Â  delete budgetHistory[sel.value]; save(HISTORY_KEY,budgetHistory); refreshHistorySelect(); renderHistory(); renderHistoryChart(); renderDeltaChart();
Â  Â  Â  }
Â  Â  }
Â  Â  function init(){
Â  Â  Â  fillMonths();
Â  Â  Â  const saved = load(STORE_KEY);
Â  Â  Â  if(saved){ state=saved; }
Â  Â  Â  if(!Array.isArray(state.investments)) state.investments=[];
Â  Â  Â  $('year-input').value = (new Date()).getFullYear();
Â  Â  Â  $('month-select').value = (new Date().getMonth()+1).toString().padStart(2,'0');
Â  Â  Â  refreshCats();
Â  Â  Â  refreshTemplates();
Â  Â  Â  refreshHistorySelect();
Â  Â  Â  renderExpenses();
Â  Â  Â  renderExtras();
Â  Â  Â  renderInvestments();
Â  Â  Â  renderHistory();
Â  Â  Â  renderHistoryChart();
Â  Â  Â  renderDeltaChart();
Â  Â  Â  updateTotals();
Â  Â  Â  ensureCatsRetries();
Â  Â  Â  runEnsures();
Â  Â  Â  bind();
Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const sel=$('name');
Â  Â  Â  Â  Â  if(sel && (!sel.options || sel.options.length===0)){
Â  Â  Â  Â  Â  Â  refreshCats();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }catch{}
Â  Â  Â  }, 200);
Â  Â  }
Â  Â  document.addEventListener('DOMContentLoaded', init);
Â  </script>

<script id="mobile-v29-enhance">
(function(){
Â  if (window.__mobileEnhanceV29Installed) return;
Â  window.__mobileEnhanceV29Installed = true;
Â  function ensurePanel(tr){
Â  Â  var panel = tr.querySelector('td.mobile-details-panel');
Â  Â  if (!panel){
Â  Â  Â  panel = document.createElement('td');
Â  Â  Â  panel.className = 'mobile-details-panel';
Â  Â  Â  var list = document.createElement('div');
Â  Â  Â  list.className = 'details-list';
Â  Â  Â  panel.appendChild(list);
Â  Â  Â  var ph = document.createElement('div');
Â  Â  Â  ph.className = 'placeholder';
Â  Â  Â  ph.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ØªÙØµÙŠÙ„ÙŠØ©';
Â  Â  Â  panel.appendChild(ph);
Â  Â  Â  tr.appendChild(panel);
Â  Â  }
Â  Â  return panel;
Â  }
Â  function updatePaidFromPanel(tr){
Â  Â  var panel = tr.querySelector('td.mobile-details-panel');
Â  Â  if (!panel) return;
Â  Â  var vals = panel.querySelectorAll('.detail-item input[data-role="value"]');
Â  Â  var sum = 0;
Â  Â  vals.forEach(function(inp){
Â  Â  Â  var v = parseFloat((inp.value || '').replace(/,/g,''));
Â  Â  Â  if (!isNaN(v)) sum += v;
Â  Â  });
Â  Â  var paidInput = tr.querySelector('td:nth-child(3) input');
Â  Â  if (paidInput){ paidInput.value = sum || 0; }
Â  Â  updateStatus(tr);
Â  }
Â  function addDetailItem(tr){
Â  Â  if (tr.dataset.detailLock === '1') return;
Â  Â  tr.dataset.detailLock = '1';
Â  Â  setTimeout(function(){ tr.dataset.detailLock = '0'; }, 300);
Â  Â  var panel = ensurePanel(tr);
Â  Â  panel.classList.add('visible');
Â  Â  var list = panel.querySelector('.details-list');
Â  Â  var item = document.createElement('div');
Â  Â  item.className = 'detail-item';
Â  Â  var name = document.createElement('input');
Â  Â  name.type = 'text';
Â  Â  name.placeholder = 'Ø§Ø³Ù… Ø§Ù„ØªÙØµÙŠÙ„';
Â  Â  var value = document.createElement('input');
Â  Â  value.type = 'number';
Â  Â  value.setAttribute('data-role','value');
Â  Â  value.placeholder = 'Ø§Ù„Ù‚ÙŠÙ…Ø©';
Â  Â  value.inputMode = 'numeric';
Â  Â  value.pattern = '[0-9]*';
Â  Â  value.addEventListener('input', function(){ updatePaidFromPanel(tr); });
Â  Â  var del = document.createElement('button');
Â  Â  del.type = 'button';
Â  Â  del.className = 'del';
Â  Â  del.textContent = 'Ã—';
Â  Â  del.addEventListener('click', function(){
Â  Â  Â  item.remove();
Â  Â  Â  var panel = ensurePanel(tr);
Â  Â  Â  var list = panel.querySelector('.details-list');
Â  Â  Â  panel.querySelector('.placeholder').style.display = list.children.length > 0 ? 'none' : 'block';
Â  Â  Â  updatePaidFromPanel(tr);
Â  Â  });
Â  Â  item.appendChild(name);
Â  Â  item.appendChild(value);
Â  Â  item.appendChild(del);
Â  Â  list.appendChild(item);
Â  Â  panel.querySelector('.placeholder').style.display = 'none';
Â  Â  updatePaidFromPanel(tr);
Â  }
Â  function hideLegacyButtons(tr){
Â  Â  var actionsCell = tr.querySelector('td:nth-child(6)');
Â  Â  if (!actionsCell) return;
Â  Â  Array.from(actionsCell.querySelectorAll('button, .btn, a')).forEach(function(b){
Â  Â  Â  var t = (b.innerText||b.textContent||'').trim();
Â  Â  Â  if (/ØªÙØµÙŠÙ„|ØªÙØ§ØµÙŠÙ„|detail|\+/.test(t)) { b.classList.add('is-details-btn'); b.style.display='none'; }
Â  Â  });
Â  }
Â  function statusElement(tr){
Â  Â  var el = tr.querySelector('.mobile-status-text');
Â  Â  if (!el){
Â  Â  Â  el = document.createElement('div');
Â  Â  Â  el.className = 'mobile-status-text neutral';
Â  Â  Â  var cell = tr.querySelector('td:nth-child(5)');
Â  Â  Â  if (cell) cell.appendChild(el);
Â  Â  }
Â  Â  return el;
Â  }
Â  function parseNum(v){ v=(v||'').toString().replace(/,/g,''); var n=parseFloat(v); return isNaN(n)?0:n; }
Â  function updateStatus(tr){
Â  Â  var pEl = tr.querySelector('td:nth-child(2) input');
Â  Â  var dEl = tr.querySelector('td:nth-child(3) input');
Â  Â  var planned = parseNum(pEl && pEl.value);
Â  Â  var paidÂ  Â  = parseNum(dEl && dEl.value);
Â  Â  var el = statusElement(tr);
Â  Â  if (!el) return;
Â  Â  if (paid > planned){
Â  Â  Â  var diff = (paid - planned).toFixed(2).replace(/\.00$/,'');
Â  Â  Â  el.className = 'mobile-status-text over';
Â  Â  Â  el.textContent = 'ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø·Ø· Ø¨Ù€ ' + diff;
Â  Â  } else if (planned > paid){
Â  Â  Â  var left = (planned - planned).toFixed(2).replace(/\.00$/,'');
Â  Â  Â  el.className = 'mobile-status-text ok';
Â  Â  Â  el.textContent = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ' + left;
Â  Â  } else {
Â  Â  Â  el.className = 'mobile-status-text neutral';
Â  Â  Â  el.textContent = 'Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø®Ø·Ø·';
Â  Â  }
Â  }
Â  function wireInputs(tr){
Â  Â  var p = tr.querySelector('td:nth-child(2) input');
Â  Â  var d = tr.querySelector('td:nth-child(3) input');
Â  Â  if (p) p.addEventListener('input', function(){ updateStatus(tr); });
Â  Â  if (d) d.addEventListener('input', function(){ updateStatus(tr); });
Â  Â  updateStatus(tr);
Â  }
Â  function enhanceRow(tr){
Â  Â  if (!tr || tr.getAttribute('data-mobile-enhanced') === '1') return;
Â  Â  var tds = tr.querySelectorAll('td'); if (tds.length < 6) return;
Â  Â  hideLegacyButtons(tr);
Â  Â  var addCell = document.createElement('td');
Â  Â  addCell.className = 'mobile-details-input';
Â  Â  var addBtn = document.createElement('button');
Â  Â  addBtn.type = 'button'; addBtn.className = 'btn'; addBtn.textContent = 'ØªÙØµÙŠÙ„ +';
Â  Â  addBtn.addEventListener('click', function(){ addDetailItem(tr); });
Â  Â  addCell.appendChild(addBtn);
Â  Â  var toggleCell = document.createElement('td');
Â  Â  toggleCell.className = 'mobile-details-toggle';
Â  Â  var toggleBtn = document.createElement('button');
Â  Â  toggleBtn.type = 'button'; toggleBtn.className = 'btn'; toggleBtn.textContent = 'Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡';
Â  Â  toggleBtn.addEventListener('click', function(){
Â  Â  Â  var panel = ensurePanel(tr);
Â  Â  Â  panel.classList.toggle('visible');
Â  Â  });
Â  Â  toggleCell.appendChild(toggleBtn);
Â  Â  ensurePanel(tr);
Â  Â  tr.appendChild(addCell);
Â  Â  tr.appendChild(toggleCell);
Â  Â  wireInputs(tr);
Â  Â  tr.setAttribute('data-mobile-enhanced','1');
Â  }
Â  function enhanceAll(){
Â  Â  var tableBody = document.getElementById('rows').querySelector('tbody');Â 
Â  Â  if(!tableBody) return;
Â  Â  var rows = tableBody.querySelectorAll('tr');
Â  Â  rows.forEach(enhanceRow);
Â  }
Â  function hideHeader(){
Â  Â  try{
Â  Â  Â  var table = document.getElementById('rows'); if(!table) return;
Â  Â  Â  var thead = table.querySelector('thead'); if (thead) thead.style.display = 'none';
Â  Â  }catch(e){}
Â  }
Â Â 
Â  function patchAddButton(){
Â  Â  var btn = document.getElementById('add');
Â  Â  if (!btn) return;
Â  Â  var clone = btn.cloneNode(true);
Â  Â  clone.removeAttribute('onclick');
Â  Â  clone.removeAttribute('ontouchend');
Â  Â  if (btn.parentNode) {
Â  Â  Â  btn.parentNode.replaceChild(clone, btn);
Â  Â  }
Â  Â  clone.addEventListener('click', addItem);
Â  }

Â  function install(){
Â  Â  if (!window.matchMedia || !window.matchMedia('(max-width: 430px)').matches) return;
Â  Â Â 
Â  Â  patchAddButton();
Â  Â  enhanceAll();Â 
Â  Â  hideHeader();Â 
Â  Â Â 
Â  Â  var tableBody = document.getElementById('rows').querySelector('tbody');
Â  Â  if (tableBody){
Â  Â  Â  var obs = new MutationObserver(function(mutations){
Â  Â  Â  Â  Â  mutations.forEach(function(mutation) {
Â  Â  Â  Â  Â  Â  Â  if (mutation.addedNodes.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  enhanceAll();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  obs.observe(tableBody, { childList: true });
Â  Â  }
Â  Â  document.documentElement.style.overflowX = 'hidden';
Â  Â  document.body.style.overflowX = 'hidden';
Â  }
Â  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', install, {once:true}); }
Â  else { install(); }
})();
</script>
</body>
</html>