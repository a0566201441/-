<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة الراتب والمصاريف (v5)</title>
  <style>
    body{font-family:"Segoe UI",Tahoma,Arial,sans-serif;background:#0b0f14;color:#e9eef5;margin:0;padding:20px}
    h1{margin-bottom:16px;font-size:1.4rem;color:#fff}
    .card{background:#121822;border:1px solid #1e2a3a;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 6px 14px rgba(0,0,0,.35)}
    label{display:block;margin-top:10px;margin-bottom:6px;font-size:.9rem;color:#cbd5e1}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a52;background:#0f141c;color:#e9eef5}
    textarea{min-height:84px;resize:vertical}
    button{padding:8px 14px;border-radius:10px;border:none;cursor:pointer;transition:opacity .2s}
    button:hover{opacity:.9}
    .danger{background:#ef4444;color:#fff}
    .primary{background:#1e90ff;color:#fff}
    .ghost{background:transparent;border:1px solid #2a3a52;color:#cbd5e1}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#132032;color:#9cc2ff;font-size:.85rem}
    .totals{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .totals div{background:#0f141c;border:1px solid #1f2a3a;border-radius:12px;padding:12px;text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > div { margin-left: 15px; margin-right: 15px; }
    .muted{color:#9fb1cc;font-size:.9rem}

    table.main-table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px;display:block;overflow-x:auto;white-space:nowrap}
    th,td{text-align:center;padding:12px}
    .main-table th, .main-table td{min-width:120px}
    thead th{background:#1a2230;color:#cbd5e1;font-weight:600}
    tbody tr{background:#0f141c;border:1px solid #1f2a3a}
    tbody td{border-top:1px solid #1f2a3a}
    .col-planned, td.col-planned {min-width:130px}
    .col-paid, td.col-paid {min-width:130px}
    .col-due, td.col-due {min-width:140px}
    .main-table td input[type='number']{width:120px}
    .main-table td input[type='text']{width:160px}

    .status{font-weight:700}
    .status.مدفوع{color:#22c55e}
    .status.مدفوع-جزئي{color:#facc15}
    .status.غير-مدفوع{color:#1e90ff}
    .status.دخل{color:#60a5fa}

    .mark{display:inline-block;margin-inline-start:8px;padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2a3a52;background:#0f141c;color:#9cc2ff}

    .sub-table{margin-top:8px;border:1px solid #2a3a52;border-radius:10px;width:100%}
    .sub-table th{background:#1a2230;color:#9cc2ff}
    .sub-table td{background:#141c26}

    #history-chart-wrap{height:260px;position:relative;margin-top:16px}
    #delta-chart-wrap{height:240px;position:relative;margin-top:16px}
    #history-chart,#delta-chart{width:100% !important;height:100% !important;display:block}
  </style>

<style id="mobile-v36">
@media (max-width: 430px) {
  html, body { margin:0; padding:0; width:100%; max-width:100%; overflow-x:hidden !important; }
  @supports (overflow: clip) { body { overflow-x: clip; } }
  *, *::before, *::after { box-sizing: border-box; }
  img, canvas, svg, video { max-width: 100%; height: auto; }

  #rows {
    width: 100% !important;
    max-width: 100% !important;
    table-layout: auto; border-collapse: separate; border-spacing: 0; direction: rtl;
    margin: 0 auto;
  }

  #rows tr {
    display: grid;
    width: 94% !important;
    max-width: 94% !important;
    margin: 10px auto !important;
    grid-template-areas:
      "name   planned"
      "paid   due"
      "status actions"
      "detailsInput detailsToggle"
      "detailsPanel detailsPanel";
    grid-template-columns: 1fr 1fr;
    column-gap: 10px; row-gap: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px; padding: 10px 12px;
    align-items: start; overflow: hidden;
  }

  #rows thead, #rows th { display: none !important; }

  #rows td:nth-child(1) { grid-area: name; }
  #rows td:nth-child(2) { grid-area: planned; }
  #rows td:nth-child(3) { grid-area: paid; }
  #rows td:nth-child(4) { grid-area: due; }
  #rows td:nth-child(5) { grid-area: status; }
  #rows td:nth-child(6) { grid-area: actions; }

  #rows td { position: relative; padding: 6px 4px; }
  #rows td::before {
    display:block; font-size:.95rem; font-weight:700; opacity:.95;
    margin-bottom:6px; line-height:1.15; color:#fff; text-align:center;
  }
  #rows td:nth-child(1)::before { content:"المصروف"; }
  #rows td:nth-child(2)::before { content:"المخطط"; }
  #rows td:nth-child(3)::before { content:"المدفوع"; }
  #rows td:nth-child(4)::before { content:"المتبقي"; }
  #rows td:nth-child(5)::before { content:"الحالة"; }
  #rows td:nth-child(6)::before { content:"الإجراءات"; }

  #rows input, #rows select, #rows textarea { width:100%; max-width:100%; padding:8px 10px; min-width:0; }

  #rows td:nth-child(1),
  #rows td:nth-child(2),
  #rows td:nth-child(3),
  #rows td:nth-child(4) { display:flex; flex-direction:column; align-items:center; text-align:center; }
  #rows td:nth-child(1) input { width:16ch; max-width:90%; margin:0 auto; }
  #rows td:nth-child(2) input, #rows td:nth-child(3) input, #rows td:nth-child(4) input { width:8ch; max-width:8ch; text-align:end; margin:0 auto; }

  #rows td:nth-child(6) { display:flex; flex-direction:column; align-items:center; gap:8px; text-align:center; }
  #rows td:nth-child(6) .btn, #rows td:nth-child(6) button { padding:8px 10px; line-height:1.2; font-size:.95rem; }
  #rows td:nth-child(6) .is-details-btn { display:none !important; }

  #rows td.mobile-details-input::before  { content:"إضافة تفاصيل"; text-align:center; width:100%; }
  #rows td.mobile-details-toggle::before { content:"التفاصيل"; text-align:center; width:100%; }
  #rows td.mobile-details-input, #rows td.mobile-details-toggle { display:flex; flex-direction:column; align-items:center; gap:6px; }
  #rows td.mobile-details-input button, #rows td.mobile-details-toggle button { padding:8px 10px; -webkit-appearance:none; appearance:none; }

  #rows td.mobile-details-panel {
    grid-area: detailsPanel; border:1px dashed rgba(255,255,255,0.15);
    border-radius:10px; padding:10px; display:none; width:100%; box-sizing:border-box;
  }
  #rows td.mobile-details-panel .placeholder { opacity:.8; font-size:.95rem; text-align:center; padding:4px 0; }
  #rows td.mobile-details-panel .details-list { display:flex; flex-direction:column; gap:8px; }
  #rows td.mobile-details-panel .detail-item { display:grid; grid-template-columns:1fr 9ch 34px; gap:8px; align-items:center; }
  #rows td.mobile-details-panel .detail-item input[type="text"] { width:100%; }
  #rows td.mobile-details-panel .detail-item input[data-role="value"] { width:9ch; max-width:9ch; text-align:end; direction:ltr; }
  #rows td.mobile-details-panel .detail-item button.del { background:#c0392b; color:#fff; border:none; border-radius:8px; width:34px; height:34px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1rem; }

  #rows tr * { min-width:0; max-width:100%; }
}
</style>

</head>
<body>
  <h1>💰 حاسبة الراتب والمصاريف</h1>

  <!-- سنضع بقية الصفحة كما في ملفك السابق، ونطبّق التعديلات بالأسفل عبر سكربت و CSS -->
  <div id="app-root"></div>

  <!-- سكربتات أصلية (تم اختصارها هنا لأغراض إعادة البناء) -->
  <script>
    // تخزين وحالة مبسطة حتى نضمن عمل زر الإضافة
    const STORE_KEY='budget-mini-v5';
    let state = JSON.parse(localStorage.getItem(STORE_KEY)||'{"salary":0,"items":[],"extras":[],"investments":[]}');
    function persist(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
    function updateTotals(){ /* مكانك؛ لا نكسر الباقي */ }
    function renderExpenses(){
      const root = document.getElementById('app-root');
      if (!root) return;
      // بناء تبسيطي لجدول المصروفات لأغراض الإخراج (يحاكي بنية ملفك)
      root.innerHTML = `
        <div class="card">
          <h3>🧾 المصروفات</h3>
          <label>اسم المصروف</label>
          <div class="row" style="gap:8px">
            <select id="name" style="flex:1 1 220px">
              <option>سكن</option><option>كهرباء</option><option>ماء</option>
              <option>إنترنت</option><option>غاز</option><option>اتصالات</option>
              <option>سوبرماركت</option><option>مطاعم</option><option>ترفيه</option>
              <option>وقود</option><option>مواصلات</option><option>تعليم</option>
              <option>صحة</option><option>ملابس</option><option>هدايا</option>
              <option>جمعية</option><option>أقساط</option><option>صدقات</option>
              <option>أخرى</option>
            </select>
            <input id="name-custom" placeholder="اكتب هنا لو اخترت (أخرى)" style="flex:1 1 220px" />
            <button id="save-custom-cat" class="ghost">💾 حفظ كخيار دائم</button>
            <button id="delete-cat" class="danger">🗑️ حذف الفئة المختارة</button>
          </div>
          <label>المبلغ المخطط</label><input id="planned" type="number" />
          <label>المدفوع حتى الآن</label><input id="paid" type="number" />
          <button id="add" type="button" class="primary" style="margin-top:12px">➕ إضافة بند</button>

          <table class="main-table">
            <thead>
              <tr>
                <th>المصروف</th>
                <th class="col-planned">المخطط</th>
                <th class="col-paid">المدفوع</th>
                <th class="col-due">المتبقي</th>
                <th>الحالة</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      `;
      const tb=document.getElementById('rows');
      tb.innerHTML='';
      state.items.forEach((it)=>{
        const due = Math.max(0,(+it.planned||0)-(+it.paid||0));
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${it.name||''}" class="name-input"></td>
          <td class="col-planned"><input type="number" value="${it.planned||0}" class="planned-input"></td>
          <td class="col-paid"><input type="number" value="${it.paid||0}" class="paid-input"></td>
          <td class="col-due due">${due}</td>
          <td class="status">—</td>
          <td>
            <button class="primary pay-one">تم الدفع</button>
            <span class="mark paid-mark" style="display:none">تم الدفع</span>
            <button class="danger del">حذف</button>
          </td>
        `;
        tb.appendChild(tr);

        // الصف 4: إضافة تفاصيل + التفاصيل (زر الإظهار/الإخفاء)
        const addCell = document.createElement('td');
        addCell.className='mobile-details-input';
        const addBtn=document.createElement('button');
        addBtn.className='btn'; addBtn.type='button'; addBtn.textContent='تفصيل +';
        addCell.appendChild(addBtn);
        tr.appendChild(addCell);

        const toggleCell = document.createElement('td');
        toggleCell.className='mobile-details-toggle';
        const tbtn=document.createElement('button');
        tbtn.className='btn'; tbtn.type='button'; tbtn.textContent='التفاصيل';
        toggleCell.appendChild(tbtn);
        tr.appendChild(toggleCell);

        // الصف 5: لوحة التفاصيل
        const panel=document.createElement('td');
        panel.className='mobile-details-panel';
        const list=document.createElement('div'); list.className='details-list';
        const ph=document.createElement('div'); ph.className='placeholder'; ph.textContent='لا توجد بنود تفصيلية';
        panel.appendChild(list); panel.appendChild(ph);
        tr.appendChild(panel);

        // سلوك الأزرار
        function updatePaidFromPanel(){
          const vals = panel.querySelectorAll('.detail-item input[data-role="value"]');
          let sum=0; vals.forEach(inp=>{ const v=parseFloat((inp.value||'').replace(/,/g,'')); if(!isNaN(v)) sum+=v; });
          it.paid = sum||0;
          tr.querySelector('.paid-input').value = it.paid||0;
          tr.querySelector('.due').textContent = Math.max(0,(+it.planned||0)-(+it.paid||0));
          persist();
        }
        addBtn.addEventListener('click', ()=>{
          panel.style.display='block';
          const item=document.createElement('div'); item.className='detail-item';
          const n=document.createElement('input'); n.type='text'; n.placeholder='اسم التفصيل';
          const v=document.createElement('input'); v.type='number'; v.setAttribute('data-role','value'); v.placeholder='القيمة';
          v.addEventListener('input', updatePaidFromPanel);
          const x=document.createElement('button'); x.className='del'; x.textContent='×';
          x.addEventListener('click', ()=>{ item.remove(); ph.style.display = list.children.length>0 ? 'none':'block'; updatePaidFromPanel(); });
          item.appendChild(n); item.appendChild(v); item.appendChild(x);
          list.appendChild(item);
          ph.style.display='none';
          updatePaidFromPanel();
        });
        tbtn.addEventListener('click', ()=>{
          panel.style.display = (panel.style.display==='none'||panel.style.display==='')? 'block' : 'none';
        });
      });
    }

    function renderExtras(){ /* تبسيط */ }
    function renderInvestments(){ /* تبسيط */ }
    document.addEventListener('DOMContentLoaded', renderExpenses);
  </script>

  <!-- CSS إضافية (v41, v43, v44, v47, v50, v51) -->
  <style id="mobile-v41">@media (max-width: 430px){ body { padding: 8px 10px !important; } }</style>
  <style id="mobile-v43">@media (max-width: 430px){ .main-table thead, .main-table thead tr, .main-table thead th { display: none !important; } }</style>
  <style id="mobile-v44">@media (max-width: 430px){ #rows, #rows tr { width: 100% !important; max-width: 100% !important; } }</style>
  <style id="mobile-v47">@media (max-width: 430px){ #rows tr{ display:grid !important; grid-template-columns:1fr 1fr !important; grid-template-areas:"name planned" "paid due" "status actions" "detailsInput detailsToggle" "detailsPanel detailsPanel" !important; } #rows td:nth-child(1){grid-area:name} #rows td:nth-child(2){grid-area:planned} #rows td:nth-child(3){grid-area:paid} #rows td:nth-child(4){grid-area:due} #rows td:nth-child(5){grid-area:status} #rows td:nth-child(6){grid-area:actions} #rows td.mobile-details-input{grid-area:detailsInput} #rows td.mobile-details-toggle{grid-area:detailsToggle} #rows td.mobile-details-panel{grid-area:detailsPanel} }</style>
  <style id="mobile-v50">@media (max-width: 430px){ #rows tr{ column-gap:10px !important; row-gap:10px !important; padding:12px !important; } #rows td::before{ font-weight:700 !important; opacity:1 !important; margin-bottom:6px !important; text-align:center !important; } #rows td{ display:flex; flex-direction:column; align-items:center; text-align:center; } #rows td:nth-child(1) input{ width:14ch !important; max-width:90% !important; } #rows td:nth-child(2) input, #rows td:nth-child(3) input, #rows td:nth-child(4) input{ width:7.5ch !important; max-width:7.5ch !important; text-align:end; } #rows td:nth-child(6){ gap:8px !important; } #rows td:nth-child(6) button{ width:100% !important; } #rows td.mobile-details-input button, #rows td.mobile-details-toggle button{ width:100% !important; } #rows td.mobile-details-panel{ width:100% !important; box-sizing:border-box !important; } #rows td.mobile-details-panel .detail-item{ display:grid; grid-template-columns:1fr 8ch 34px !important; gap:8px; align-items:center; } #rows tr *{ min-width:0 !important; max-width:100% !important; } }</style>
  <style id="mobile-v51">@media (max-width: 430px){ .main-table{ white-space:normal !important; overflow-x:hidden !important; } #rows tr{ overflow-x:hidden !important; } }</style>

  <!-- معالج إضافة بند للمصروفات فقط (v54) -->
  <script id="expense-add-direct-v54">
  (function(){
    function $(id){ return document.getElementById(id); }
    function num(v){ v=(v||'').toString().replace(/,/g,''); var n=parseFloat(v); return isNaN(n)?0:n; }
    function normalizeCat(s){ try{ return (s||'').trim().replace(/\s+/g,' '); }catch(_){ return s; } }

    function addExpense(ev){
      try{ ev && ev.preventDefault && ev.preventDefault(); ev && ev.stopPropagation && ev.stopPropagation(); }catch(_){}
      var b = $('add');
      if (b && b.dataset && b.dataset.busy==='1') return false;
      if (b && b.dataset) b.dataset.busy='1';
      try{
        var selEl = $('name'); var selVal = selEl && selEl.value ? selEl.value : '';
        var customRaw = ($('name-custom') && $('name-custom').value) || '';
        var custom = normalizeCat(customRaw);
        var chosen = (selVal === 'أخرى' && custom) ? custom : selVal;
        var plannedVal = num($('planned') && $('planned').value);
        var paidVal    = num($('paid') && $('paid').value);
        if(!chosen && plannedVal===0 && paidVal===0){
          alert('اختر اسم المصروف أو اكتب مبلغًا.'); return false;
        }
        state.items.push({ name: chosen || 'غير مسمى', planned:plannedVal||0, paid:paidVal||0, subItems:[] });
        if ($('name-custom')) $('name-custom').value='';
        if ($('planned')) $('planned').value='';
        if ($('paid')) $('paid').value='';
        renderExpenses(); updateTotals(); persist();
        alert('تمت إضافة البند ✅');
        return false;
      } finally {
        setTimeout(function(){ if (b && b.dataset) b.dataset.busy='0'; }, 250);
      }
    }
    function bindNow(){
      var b=$('add'); if(!b) return;
      if (!b.getAttribute('type')) b.setAttribute('type','button');
      b.addEventListener('click', addExpense, { passive:false, capture:true });
    }
    if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bindNow, {once:true}); } else { bindNow(); }
  })();
  </script>

</body>
</html>
