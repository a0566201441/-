<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة الراتب والمصاريف (v5)</title>
  <style>
    body{font-family:"Segoe UI",Tahoma,Arial,sans-serif;background:#0b0f14;color:#e9eef5;margin:0;padding:20px}
    h1{margin-bottom:16px;font-size:1.4rem;color:#fff}
    .card{background:#121822;border:1px solid #1e2a3a;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 6px 14px rgba(0,0,0,.35)}
    label{display:block;margin-top:10px;margin-bottom:6px;font-size:.9rem;color:#cbd5e1}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a52;background:#0f141c;color:#e9eef5}
    textarea{min-height:84px;resize:vertical}
    button{padding:8px 14px;border-radius:10px;border:none;cursor:pointer;transition:opacity .2s}
    button:hover{opacity:.9}
    .danger{background:#ef4444;color:#fff}
    .primary{background:#1e90ff;color:#fff}
    .ghost{background:transparent;border:1px solid #2a3a52;color:#cbd5e1}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#132032;color:#9cc2ff;font-size:.85rem}
    .totals{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .totals div{background:#0f141c;border:1px solid #1f2a3a;border-radius:12px;padding:12px;text-align:center}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > div { margin-left: 15px; margin-right: 15px; }
    .muted{color:#9fb1cc;font-size:.9rem}

    table.main-table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px;display:block;overflow-x:auto;white-space:nowrap}
    th,td{text-align:center;padding:12px}
    .main-table th, .main-table td{min-width:120px}
    thead th{background:#1a2230;color:#cbd5e1;font-weight:600}
    tbody tr{background:#0f141c;border:1px solid #1f2a3a}
    tbody td{border-top:1px solid #1f2a3a}
    .col-planned, td.col-planned {min-width:130px}
    .col-paid, td.col-paid {min-width:130px}
    .col-due, td.col-due {min-width:140px}
    .main-table td input[type='number']{width:120px}
    .main-table td input[type='text']{width:160px}

    .status{font-weight:700}
    .status.مدفوع{color:#22c55e}
    .status.مدفوع-جزئي{color:#facc15}
    .status.غير-مدفوع{color:#1e90ff}
    .status.دخل{color:#60a5fa}

    .mark{display:inline-block;margin-inline-start:8px;padding:2px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2a3a52;background:#0f141c;color:#9cc2ff}

    .sub-table{margin-top:8px;border:1px solid #2a3a52;border-radius:10px;width:100%}
    .sub-table th{background:#1a2230;color:#9cc2ff}
    .sub-table td{background:#141c26}

    #history-chart-wrap{height:260px;position:relative;margin-top:16px}
    #delta-chart-wrap{height:240px;position:relative;margin-top:16px}
    #history-chart,#delta-chart{width:100% !important;height:100% !important;display:block}
  </style>































<style id="mobile-v36">
@media (max-width: 430px) {
  /* Lock horizontal scroll globally */
  html, body { margin:0; padding:0; width:100%; max-width:100%; overflow-x:hidden !important; }
  @supports (overflow: clip) { body { overflow-x: clip; } }
  *, *::before, *::after { box-sizing: border-box; }
  img, canvas, svg, video { max-width: 100%; height: auto; }

  /* Make table follow the page container width (not full-bleed) */
  #rows {
    width: 100% !important;
    max-width: 100% !important;
    table-layout: auto; border-collapse: separate; border-spacing: 0; direction: rtl;
    margin: 0 auto;
  }

  /* Card: 94% of container width (not vw), centered */
  #rows tr {
    display: grid;
    width: 94% !important;
    max-width: 94% !important;
    margin: 10px auto !important;
    grid-template-areas:
      "name   planned"
      "paid   due"
      "status actions"
      "detailsInput detailsToggle"
      "detailsPanel detailsPanel";
    grid-template-columns: 1fr 1fr;
    column-gap: 10px; row-gap: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px; padding: 10px 12px;
    align-items: start; overflow: hidden;
  }

  #rows thead, #rows th { display: none !important; }

  #rows td:nth-child(1) { grid-area: name; }
  #rows td:nth-child(2) { grid-area: planned; }
  #rows td:nth-child(3) { grid-area: paid; }
  #rows td:nth-child(4) { grid-area: due; }
  #rows td:nth-child(5) { grid-area: status; }
  #rows td:nth-child(6) { grid-area: actions; }

  #rows td { position: relative; padding: 6px 4px; }
  #rows td::before {
    display:block; font-size:.95rem; font-weight:700; opacity:.95;
    margin-bottom:6px; line-height:1.15; color:#fff; text-align:center;
  }
  #rows td:nth-child(1)::before { content:"المصروف"; }
  #rows td:nth-child(2)::before { content:"المخطط"; }
  #rows td:nth-child(3)::before { content:"المدفوع"; }
  #rows td:nth-child(4)::before { content:"المتبقي"; }
  #rows td:nth-child(5)::before { content:"الحالة"; }
  #rows td:nth-child(6)::before { content:"الإجراءات"; }

  #rows input, #rows select, #rows textarea { width:100%; max-width:100%; padding:8px 10px; min-width:0; }

  #rows td:nth-child(1),
  #rows td:nth-child(2),
  #rows td:nth-child(3),
  #rows td:nth-child(4) { display:flex; flex-direction:column; align-items:center; text-align:center; }
  #rows td:nth-child(1) input { width:16ch; max-width:90%; margin:0 auto; }
  #rows td:nth-child(2) input, #rows td:nth-child(3) input, #rows td:nth-child(4) input { width:8ch; max-width:8ch; text-align:end; margin:0 auto; }

  #rows td:nth-child(6) { display:flex; flex-direction:column; align-items:center; gap:8px; text-align:center; }
  #rows td:nth-child(6) .btn, #rows td:nth-child(6) button { padding:8px 10px; line-height:1.2; font-size:.95rem; }
  #rows td:nth-child(6) .is-details-btn { display:none !important; }

  #rows td.mobile-details-input::before  { content:"إضافة تفاصيل"; text-align:center; width:100%; }
  #rows td.mobile-details-toggle::before { content:"التفاصيل"; text-align:center; width:100%; }
  #rows td.mobile-details-input, #rows td.mobile-details-toggle { display:flex; flex-direction:column; align-items:center; gap:6px; }
  #rows td.mobile-details-input button, #rows td.mobile-details-toggle button { padding:8px 10px; -webkit-appearance:none; appearance:none; }

  #rows td.mobile-details-panel {
    grid-area: detailsPanel; border:1px dashed rgba(255,255,255,0.15);
    border-radius:10px; padding:10px; display:none; width:100%; box-sizing:border-box;
  }
  #rows td.mobile-details-panel .placeholder { opacity:.8; font-size:.95rem; text-align:center; padding:4px 0; }
  #rows td.mobile-details-panel .details-list { display:flex; flex-direction:column; gap:8px; }
  #rows td.mobile-details-panel .detail-item { display:grid; grid-template-columns:1fr 9ch 34px; gap:8px; align-items:center; }
  #rows td.mobile-details-panel .detail-item input[type="text"] { width:100%; }
  #rows td.mobile-details-panel .detail-item input[data-role="value"] { width:9ch; max-width:9ch; text-align:end; direction:ltr; }
  #rows td.mobile-details-panel .detail-item button.del { background:#c0392b; color:#fff; border:none; border-radius:8px; width:34px; height:34px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:1rem; }

  #rows tr * { min-width:0; max-width:100%; }
}
</style>


<style id="mobile-v37">
@media (max-width: 430px){
  #rows { width:95% !important; max-width:95% !important; margin:0 auto; }
}
</style>

</head>
<body>
  <h1>💰 حاسبة الراتب والمصاريف</h1>

  <!-- (1) المرحلة الأولى: السنة والشهر والقوالب -->
  <div class="card">
    <div class="row">
      <div style="flex:1 1 200px">
        <label>السنة</label>
        <input id="year-input" type="number" />
      </div>
      <div style="flex:1 1 220px">
        <label>الشهر (ميلادي)</label>
        
        <select id="month-select">
          <option value="01">يناير</option>
          <option value="02">فبراير</option>
          <option value="03">مارس</option>
          <option value="04">أبريل</option>
          <option value="05">مايو</option>
          <option value="06">يونيو</option>
          <option value="07">يوليو</option>
          <option value="08">أغسطس</option>
          <option value="09">سبتمبر</option>
          <option value="10">أكتوبر</option>
          <option value="11">نوفمبر</option>
          <option value="12">ديسمبر</option>
        </select>

      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="save-template" class="primary">💾 حفظ كقالب</button>
      <div style="flex:1 1 260px">
        <label>القوالب</label>
        <div class="row">
          <select id="templates-select" style="flex:1 1 220px"></select>
          <button id="apply-template" class="ghost">تطبيق</button>
          <button id="delete-template" class="danger">حذف القالب</button>
        </div>
      </div>
      <button id="close-month" class="primary">📦 إغلاق الشهر وحفظه</button>
      <button id="reset" class="danger">تفريغ الكل</button>
      <button id="export-history" class="ghost">تصدير الأرشيف JSON</button>
      <button id="export-csv" class="ghost">تصدير CSV</button>
      <input type="file" id="import-history" accept="application/json" style="display:none" />
      <button id="import-history-btn" class="ghost">استيراد أرشيف</button>
    </div>
  </div>

  <!-- (2) المرحلة الثانية: الدخل الشهري -->
  <div class="card">
    <h3>💵 الدخل الشهري (راتب)</h3>
    <div class="row" style="align-items:flex-end">
      <div style="flex:1 1 260px">
        <label>الراتب الشهري</label>
        <input id="salary2" type="number" placeholder="" />
      </div>
    </div>
  </div>

  <!-- (3) المرحلة الثالثة: الدخل الإضافي + المصروفات -->
  <div class="card">
    <h3>➕ الدخل الإضافي</h3>
    <label>اسم الدخل</label>
    <input id="extra-name" placeholder="مثال: عمل إضافي" />
    <label>قيمة الدخل</label>
    <input id="extra-amount" type="number" />
    <button id="add-extra" class="primary" style="margin-top:10px">➕ إضافة دخل</button>
    <table class="main-table">
      <thead>
        <tr>
          <th>دخل</th>
          <th class="col-paid">المبلغ</th>
          <th>إجراء</th>
        </tr>
      </thead>
      <tbody id="extras-rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>🧾 المصروفات</h3>
    <label>اسم المصروف</label>
    <div class="row" style="gap:8px">
      
      <select id="name" style="flex:1 1 220px">
        <option>سكن</option>
        <option>كهرباء</option>
        <option>ماء</option>
        <option>إنترنت</option>
        <option>غاز</option>
        <option>اتصالات</option>
        <option>سوبرماركت</option>
        <option>مطاعم</option>
        <option>ترفيه</option>
        <option>وقود</option>
        <option>مواصلات</option>
        <option>تعليم</option>
        <option>صحة</option>
        <option>ملابس</option>
        <option>هدايا</option>
        <option>جمعية</option>
        <option>أقساط</option>
        <option>صدقات</option>
        <option>أخرى</option>
      </select>

      <input id="name-custom" placeholder="اكتب هنا لو اخترت (أخرى)" style="flex:1 1 220px" />
      <button id="save-custom-cat" class="ghost">💾 حفظ كخيار دائم</button>
      <button id="delete-cat" class="danger">🗑️ حذف الفئة المختارة</button>
    </div>
    <label>المبلغ المخطط</label><input id="planned" type="number" />
    <label>المدفوع حتى الآن</label><input id="paid" type="number" />
    <button id="add" type="button" class="primary" style="margin-top:12px" onclick="return addItemInline(event)" ontouchend="return addItemInline(event)">➕ إضافة بند</button>

    <table class="main-table">
      <thead>
        <tr>
          <th>المصروف</th>
          <th class="col-planned">المخطط</th>
          <th class="col-paid">المدفوع</th>
          <th class="col-due">المتبقي</th>
          <th>الحالة</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="totals">
      <div><div class="pill">إجمالي المخطط</div><h3 id="t_planned">0</h3></div>
      <div><div class="pill">إجمالي المدفوع</div><h3 id="t_paid">0</h3></div>
      <div><div class="pill">المتبقي على البنود</div><h3 id="t_due">0</h3></div>
      <div><div class="pill">الرصيد المتوقع</div><h3 id="t_balance">0</h3></div>
    </div>
  </div>

  <!-- (4) المرحلة الرابعة: الاستثمارات -->
  <div class="card">
    <h3>📈 الاستثمارات</h3>
    <p class="muted">هذه القائمة مستقلة تمامًا ولا تؤثر على المصروفات أو الأرصدة.</p>
    <div class="row">
      <div style="flex:1 1 220px">
        <label>نوع الاستثمار</label>
        <input id="inv-type" placeholder="مثال: أسهم، بيتكوين، عقار" />
      </div>
      <div style="flex:1 1 220px">
        <label>الوجهة / أين ذهبت الأموال</label>
        <input id="inv-dest" placeholder="مثال: Tesla، BTC Wallet، صندوق مؤشر" />
      </div>
      <div style="flex:1 1 180px">
        <label>المبلغ (هذا الشهر)</label>
        <input id="inv-amount" type="number" />
      </div>
      <div style="flex:1 1 220px">
        <label>مصدر الأموال</label>
        <input id="inv-source" placeholder="راتب، دخل إضافي، سحب من ادخار..." />
      </div>
    </div>
    <label>ملاحظات / تفاصيل إضافية (اختياري)</label>
    <textarea id="inv-notes" placeholder="تفاصيل مثل: التاريخ، الوسيط، رسوم..."></textarea>
    <button id="add-inv" class="primary" style="margin-top:12px">➕ إضافة استثمار</button>

    <table class="main-table">
      <thead>
        <tr>
          <th>النوع</th>
          <th>الوجهة</th>
          <th class="col-paid">المبلغ</th>
          <th>المصدر</th>
          <th>الشهر</th>
          <th>تفاصيل</th>
          <th>إجراء</th>
        </tr>
      </thead>
      <tbody id="inv-rows"></tbody>
    </table>
  </div>

  <!-- (5) المرحلة الخامسة: الأرشيف الشهري -->
  <div class="card">
    <h3>📚 الأرشيف الشهري</h3>
    <div class="row" style="margin-bottom:10px">
      <div style="flex:1 1 220px">
        <label>اختر شهرًا</label>
        <select id="history-select"></select>
      </div>
      <button id="delete-month" class="danger">حذف هذا الشهر</button>
    </div>
    <div id="history-kpis" class="totals"></div>
    <div id="history-table-wrap"></div>

    <div id="history-chart-wrap">
      <canvas id="history-chart"></canvas>
    </div>

    <div id="delta-chart-wrap">
      <canvas id="delta-chart"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const $=id=>document.getElementById(id);
    const STORE_KEY='budget-mini-v5';
    const HISTORY_KEY='budget-history-v5';
    const TEMPLATES_KEY='budget-templates-v4'; // القوالب كما هي
    const CATS_KEY='budget-custom-cats-v1';
    const DELETED_CATS_KEY='budget-deleted-cats-v1';

    let state={salary:0,items:[],extras:[],investments:[]};
    // جرّب تحميل إصدارات قديمة إن وُجدت
    const legacyStoreV4 = JSON.parse(localStorage.getItem('budget-mini-v4')||'null');
    if(!localStorage.getItem(STORE_KEY) && legacyStoreV4){
      state = { ...legacyStoreV4, investments: legacyStoreV4.investments || [] };
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }

    // ضمان ظهور خيارات المصاريف حتى في حالات Safari/iOS

    // ضمان تعبئة كل القوائم المنسدلة المهمة (الشهور، الفئات، القوالب، الأرشيف)
    function ensureSelectPopulated(id, fillerFn, fallbackBuilder) {
      const sel = $(id);
      let tries = 0;
      const tick = () => {
        tries++;
        try {
          if (sel && sel.options and sel.options.length === 0) {
            if (typeof fillerFn === 'function') fillerFn();
          }
          if (sel && sel.options && sel.options.length === 0 and typeof fallbackBuilder === 'function') {
            const opts = fallbackBuilder();
            if (Array.isArray(opts) and opts.length) {
              opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                sel.appendChild(opt);
              });
            }
          }
        } catch(e){}
        if (sel && sel.options && sel.options.length === 0 and tries < 6) {
          setTimeout(tick, 200);
        }
      };
      setTimeout(tick, 120);
    }

    function runEnsures(){
      ensureSelectPopulated('month-select', fillMonths, () => [
        {value:'01', text:'يناير'},{value:'02', text:'فبراير'},{value:'03', text:'مارس'},
        {value:'04', text:'أبريل'},{value:'05', text:'مايو'},{value:'06', text:'يونيو'},
        {value:'07', text:'يوليو'},{value:'08', text:'أغسطس'},{value:'09', text:'سبتمبر'},
        {value:'10', text:'أكتوبر'},{value:'11', text:'نوفمبر'},{value:'12', text:'ديسمبر'},
      ]);
      ensureSelectPopulated('name', refreshCats, () => (defaultCats||[]).map(c=>({value:c,text:c})) );
      ensureSelectPopulated('templates-select', refreshTemplates, () => [{value:'', text:'— لا توجد قوالب —'}]);
      ensureSelectPopulated('history-select', refreshHistorySelect, () => [{value:'', text:'— لا يوجد أرشيف —'}]);
    }

    function ensureCatsRetries() {
      const sel = $('name');
      let attempts = 0;
      const tick = () => {
        attempts++;
        if (sel && sel.options && sel.options.length === 0) {
          try { refreshCats(); } catch(e){}
        }
        if (sel && sel.options && sel.options.length === 0 && attempts < 5) {
          setTimeout(tick, 200);
        }
      };
      setTimeout(tick, 150);
    }

    let budgetHistory = load(HISTORY_KEY) || {};
    // ترقية الأرشيف القديم إن وجد (v4)
    const legacyHistoryV4 = JSON.parse(localStorage.getItem('budget-history-v4')||'null');
    if(!Object.keys(budgetHistory).length && legacyHistoryV4){
      budgetHistory = legacyHistoryV4; save(HISTORY_KEY,budgetHistory);
    }

    let templates = load(TEMPLATES_KEY) || {};
    let customCats = load(CATS_KEY) || [];
    let deletedCats = load(DELETED_CATS_KEY) || [];

    let historyChart=null, deltaChart=null;

    function load(key){ try{ return JSON.parse(localStorage.getItem(key)||'null') }catch{ return null } }
    function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
    function persist(){ save(STORE_KEY,state) }

    function normalizeCat(s){ return (s||'').trim().replace(/\s+/g,' '); }

    function monthNow(){ const d=new Date();const m=(d.getMonth()+1).toString().padStart(2,'0');return `${d.getFullYear()}-${m}`; }

    // الشهور
    const months = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
    function fillMonths(){
      const sel=$('month-select'); sel.innerHTML='';
      months.forEach((m,i)=>{ const v=(i+1).toString().padStart(2,'0'); const opt=document.createElement('option'); opt.value=v; opt.textContent=m; sel.appendChild(opt); });
    }

    // ... (remaining JS unchanged for brevity in this embedding)
  </script>





<script id="mobile-v29-enhance">
(function(){
  if (window.__mobileEnhanceV29Installed) return;
  window.__mobileEnhanceV29Installed = true;
  /* ... rest of the script unchanged ... */
})();
</script>
</body>
</html>